# 作業ログ - v3 データ統合への移行と接続完了 (2025-09-21)

## 概要
- CSV取り込み〜台帳保存〜分析〜UI表示までを v3 アーキテクチャで一通り接続しました。
- 旧v2互換経路は撤去・非使用化し、`TransactionEntity` を中心としたシンプルな経路に整理しました。
- 手動テストでプレビュー・保存・ダッシュボード・データベース表示まで動作確認済みです。

## 主要変更点
- Domain
  - `src/domain/entities/AssetEntity.js` を Domain 配下へ移動（参照更新）
  - `src/domain/entities/TransactionEntity.js` 新規追加（共通台帳エンティティ、必須項目・不変条件・指紋生成）

- Infrastructure
  - `src/infrastructure/parsers/RakutenCsvParser.js`
    - v3 専用化：`parseCsvFile` は `entities: TransactionEntity[]` を返却
    - 文字コード判定（Shift_JIS など）・柔軟ヘッダ対応は維持
    - 変換ロジックの構文エラーを修正（INVST ブロックの括弧閉じ）
    - 行単位の正規化例外で「行番号＋メッセージ」を日本語ログ出力

- Data
  - `src/data/repositories/TransactionRepository.js` 新規
    - `upsertBatch(meta, txns, { dedupeBy: 'fingerprint' })`
    - `listByDateRange(from, to)`, `getAll()`
  - `src/data/repositories/ExposureRepository.js` 新規（最小実装）
    - `getSectorExposure(key)`, `getRegionExposure(key)`（未設定はデフォルト重み）
  - `src/business/services/TransactionDatabaseService.js`
    - v2の `getAllAssets()` 依存を廃止
    - `DataStoreManager.load('investment-transactions')` を参照し、旧UIテーブルDTOへ射影する関数を追加

- Business / Services
  - `src/business/analysis/PortfolioAggregator.js`
    - `fromEntitiesToPositions(entities)`（数量ネット、加重平均原価、コスト）
    - `aggregateExposure(positions, exposureRepo)`（重み×値の配分）
  - `src/services/PortfolioAnalysisService.js` 新規
    - 台帳→positions→exposure のユースケース提供

- Application / UI
  - `src/services/CsvImportService.js`
    - フラグ撤去・v3専用。プレビューは `entities` を UI 表示用に射影して返却
    - `parseAndImport(file, csvType, progress, { dryRun })` を追加（保存一括）
  - `src/ui/controllers/CsvImportController.js`
    - プレビュー/インポートのエラーログ強化
  - `src/ui/controllers/DashboardController.js`
    - `PortfolioAnalysisService` を使ってセクター配分チャートを v3 経路で描画
  - `src/ui/controllers/DatabaseController.js`, `src/ui/Router.js`
    - ESM export と UMD 競合を解消（`window.DatabaseController` に統一、Router は window 経由で参照）

## 不具合修正
- RakutenCsvParser 構文エラー
  - `convertRowToTransactionEntity` の INVST ブロック閉じ漏れを修正（Unexpected token '{' 解消）
- DatabaseController export 競合
  - ES Module と UMD の二重エクスポートを整理。Router 側は window 経由参照に変更
- Database 画面の TypeError 解消
  - `TransactionDatabaseService` を v3 台帳参照に切替（`getAllAssets()` 依存を撤去）

## 手動確認メモ
- CSV: `JP` 形式（Shift_JIS）
  - プレビュー: 9行 → 9 エンティティ（正常）
  - 保存: `investment-transactions` に upsert。再取込は skipped でデデュープ確認
- ダッシュボード
  - セクター配分チャートが v3 経路で描画（ExposureRepository デフォルト重み使用）
- データベース
  - 取引テーブルに台帳由来のデータが表示（DTO射影経由）。フィルタ・統計表示OK

## ロギング強化（日本語）
- すべての主要変更ファイルに `[ファイル名] メソッド/処理 エラー: 内容` のログを追加
  - 例: `[RakutenCsvParser.js] 行N の正規化に失敗: ...`
  - 例: `[TransactionRepository.js] upsertBatch エラー: ...`
  - 例: `[DashboardController.js] initialize エラー: ...`

## 影響ファイル一覧
- Domain
  - `src/domain/entities/AssetEntity.js`（移動）
  - `src/domain/entities/TransactionEntity.js`（新規）
- Infrastructure
  - `src/infrastructure/parsers/RakutenCsvParser.js`
- Data
  - `src/data/repositories/TransactionRepository.js`（新規）
  - `src/data/repositories/ExposureRepository.js`（新規）
  - `src/business/services/TransactionDatabaseService.js`（改修）
- Business / Services
  - `src/business/analysis/PortfolioAggregator.js`（拡張）
  - `src/services/PortfolioAnalysisService.js`（新規）
- Application / UI
  - `src/services/CsvImportService.js`（改修）
  - `src/ui/controllers/CsvImportController.js`（改修）
  - `src/ui/controllers/DashboardController.js`（改修）
  - `src/ui/controllers/DatabaseController.js`（改修）
  - `src/ui/Router.js`（改修）

## TODO / 次の一手
- Exposure マスタの編集UI（手動設定の利便性向上）
- 月次パフォーマンスの v3 台帳集計化（現状はダミー）
- 受け入れ基準の自動チェック（符号規約・円フロー一致・デデュープ率）
- ドキュメント整備：v2経路の完全撤去手順、既存箇所の最終クリーニング

---
作成者: Codex CLI（自動生成ログ）
