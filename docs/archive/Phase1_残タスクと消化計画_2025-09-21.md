# フェーズ1 残タスクと消化計画（2025-09-21）

## 対象範囲（Phase 1 定義）
- v3データ統合の基盤構築と既存UIへの最小接続を完了させる
- 旧v2経路の撤去・ドキュメント更新・基本的な品質担保（ログ/整合性チェック）

すでに完了:
- Parser v3 専用化、TransactionEntity 実装、TransactionRepository 保存
- CsvImportService v3 接続、プレビュー射影、dryRun
- PortfolioAggregator（entities→positions、exposure 合成）、PortfolioAnalysisService
- ダッシュボード配分チャート（セクター）接続、Database テーブル v3 表示

---

## 残タスク一覧（Phase 1 内で完遂）

| No | タスク | 詳細 | 重要度 | 目安 | 関連ファイル |
|----|--------|------|--------|------|--------------|
| 1 | Parser のレガシー撤去 | `convertToStandardFormat/convertSingleRow` の完全撤去と呼出削除 | 高 | 1.5h | `src/infrastructure/parsers/RakutenCsvParser.js` |
| 2 | Router/Controller 読込順の明確化 | DatabaseController を window 経由に統一、読み込み順注記を docs へ | 中 | 0.5h | `src/ui/Router.js`, `src/ui/controllers/DatabaseController.js`, `docs/README` |
| 3 | Database 取引DTOの整備 | `TransactionDatabaseService.mapEntityToLegacyDto` の列フォーマット整備（符号・通貨表示の統一） | 中 | 1.0h | `src/business/services/TransactionDatabaseService.js`, `src/ui/components/TransactionTable.js` |
| 4 | エラーログ整備の最終反映 | コントローラ/UI 主要操作の try/catch と日本語ログの網羅確認 | 中 | 0.5h | Controller/View 一式 |
| 5 | 受け入れチェック関数（簡易） | インポート後に「符号規約」「デデュープ」「円フロー一致」を集計ログで出力 | 高 | 1.5h | `src/services/CsvImportService.js`（ユーティリティ関数追加） |
| 6 | ドキュメント更新 | v3単一化の運用注意点（プレビュー射影仕様、Router読み込み順、DB表示仕様） | 中 | 1.0h | `docs/` 一式 |

---

## 消化順序（最短クリティカルパス）
1. Parser レガシー撤去（No.1）
2. 受け入れチェック関数の追加（No.5）
3. Database DTO の列フォーマット整備（No.3）
4. Router/Controller 読込順の注記反映（No.2）
5. エラーログ整備の最終確認（No.4）
6. ドキュメント更新（No.6）

---

## 受け入れ基準（Phase 1 完了の定義）
- CSV混在（JP/US/INVST）でプレビュー→保存→再取込が安定して動く
  - 再取込は inserted=0 / skipped=n となる
- セクター配分チャートが v3 経路で表示（エラーなし）
- Database 取引テーブルが v3 台帳由来のデータを正しいフォーマットで表示
- コンソールエラー（SyntaxError/TypeError）がゼロ
- 作業ログ・戦略・設計改善書が v3 に整合

---

## 作業チェックリスト
- [ ] `RakutenCsvParser.js` から v2 変換関数を削除（呼び出しも撤去）
- [ ] `CsvImportService` に検証ユーティリティ（符号・デデュープ・円フロー）を追加し、保存後ログ出力
- [ ] `TransactionDatabaseService` の DTO 射影で金額・通貨表記を統一（符号は正規化、通貨記号の整合）
- [ ] Router/Controller の読み込み順注意を docs に記載し、実運用で順序が担保されることを確認
- [ ] Controller/View の主要操作に try/catch と `[ファイル名] エラー:` の形式でログ出力があることを確認
- [ ] `docs/archive/作業ログ_2025-09-21_v3データ統合移行.md` へのリンクを戦略/設計書に追記済みであること

---

## リスクと対策
- HTML直読み構成（UMD/ESM混載）の読み込み順依存
  - 対策: index.html の `<script>` 順序固定、Router 側の window 参照を継続
- v2 関数の取り残しによる死コード残存
  - 対策: `rg` で参照調査の上、物理削除＆lint で検知
- 受け入れチェックの human error
  - 対策: CsvImportService に簡易チェック関数を用意し、ログで定形出力

---

## 完了後（Phase 2 開始条件）
- 本ファイルのチェックリストが全て完了
- ダッシュボード/データベースでの基本操作が安定
- ドキュメントが v3 構成に整合

作成者: Codex CLI（自動下書き）

---

## 付録A: No.1 Parser レガシー撤去 詳細方針（実行計画）

目的: RakutenCsvParser から v2標準形式変換の遺存実装（convertToStandardFormat / convertSingleRow）を完全撤去し、v3正規化（TransactionEntity）のみに一本化する。

実施ステップ:
- A1 探索・影響確認
  - `rg` で `convertToStandardFormat|convertSingleRow` の参照を全体検索
  - 参照が Parser 内のみに限定されることを確認
- A2 コード撤去
  - `src/infrastructure/parsers/RakutenCsvParser.js` から対象関数を物理削除
  - 当該関数のJSDoc/コメントも併せて削除
- A3 付随文言の整合
  - `getVersion().features` の文言を v3 正規化向けに更新
  - ログ文言の「データ変換」を「正規化」に統一（既存が一致していることを確認）
- A4 ビルド・動作確認
  - JP/US/INVST のプレビュー→インポート→再取込（skipped）
  - ダッシュボード配分、Databaseテーブルに変化が無いことを確認
- A5 ドキュメント追補
  - 本ファイル（付録A）に実施結果を追記（完了チェック）

完了条件:
- 対象関数がコードベースから消えている
- 動作に変化無し（v3プレビュー/保存/表示が従来どおり）
- 参照検索で該当関数名がヒットしない

---

## 付録B: No.5 受け入れチェック関数（簡易） 詳細方針（実行計画）

目的: インポート直後に、最低限の受け入れ基準を自動チェックし、集計結果を日本語ログで出力する。

チェック観点:
- B1 符号規約の検証
  - 取引種別ごとの期待符号（流入=正/流出=負）と `settledAmount` 実値の整合
  - 不一致件数/総件数/不一致比率を集計
- B2 デデュープ結果の確認
  - `upsertBatch` の `inserted`/`skipped`/`updated` をそのまま記録（重複排除の挙動）
- B3 円キャッシュフロー整合のサマリー
  - `settledCurrency==='JPY'` の金額をそのまま集計
  - それ以外は `fxRate` があれば `settledAmount*fxRate` で推定円換算
  - 流入/流出/ネット、`fxRate` 不明件数も併記

実装場所とレイヤー:
- `src/services/CsvImportService.js`（Application Layer）
  - ユースケース（取込）完了時点で集計し、ログに出力
  - ドメインロジック（期待符号の定義）は `TransactionEntity.expectedSignByTradeType` を参照

実施ステップ:
- B-0 設計
  - `checkImportAcceptance(entities, upsertResult)` ユーティリティを実装
  - 返却: `{ sign:{mismatch,total,rate}, dedupe:{inserted,skipped,updated}, cashflow:{inflowJpy,outflowJpy,netJpy,unknownFx} }`
- B-1 呼び出し
  - `parseAndImport` の保存完了後に呼び出し、`console.info` で日本語ログ出力
- B-2 動作確認
  - JP/US/INVST のサンプルで、各数値が出力されることを確認
  - 不一致・unknownFx が過大な場合の改善ポイント把握

完了条件:
- インポート完了時に 3観点すべての集計ログが出力される
- 例外時もユーティリティが落ちず、0/未集計で安全に終了する

---

## 付録C: No.3 Database DTO 列フォーマット整備 詳細方針（実行計画）

目的: Database 取引テーブル用 DTO の列値を、v3台帳に沿った統一フォーマットにする（地域・通貨・符号・ティッカー表記）。

実施ステップ:
- C1 DTO規約の定義
  - region: `subtype` から `JP|US|FUND|OTHER` を採用（marketに依存しない）
  - currency: `settledCurrency` を大文字化（`JPY|USD|...`）
  - amount: 画面表示用は絶対値（符号はflowで表現）。集計は台帳の符号を利用
  - side: `tradeType` をそのまま保持（`buy|sell|...`）
- C2 実装
  - `TransactionDatabaseService.mapEntityToLegacyDto()` を修正
  - 既存UI（TransactionTable）の表示仕様に合わせ、互換を維持
- C3 確認
  - Database画面で地域・通貨・金額表示が統一されること

レイヤー: Business（DTO射影はプレゼンテーション寄りの変換だが、既存構成上 Businessサービス内で実施）

---

## 付録D: No.2 Router/Controller 読込順の注記反映 詳細方針（実行計画）

目的: ブラウザ直読み構成（UMD/ESM混在）での読み込み順による不具合を回避するため、運用注記を明示。

実施ステップ:
- D1 index.html の読み込み順を確認
  - `DatabaseController.js` を `Router.js`/`app.js` より先に読み込む（現状OK）
- D2 ドキュメント注記
  - 本ファイルに注意書きを追記（読み込み順が崩れると Database ルート登録が失敗）

レイヤー: Presentation/Infrastructure（ビルド無しブラウザ運用時の留意点）

---

## 付録E: No.4 エラーログ整備 最終確認 詳細方針（実行計画）

目的: 主要フローで try/catch ログが網羅され、ユーザーが問題箇所を特定しやすい状態にする。

実施ステップ:
- E1 UIコントローラの重要処理を try/catch で保護し `[ファイル] メッセージ: 内容` 形式で出力
- E2 チャート初期化や非同期呼び出し箇所にもガードを追加
- E3 デバッグモードOFF時は情報ログを抑制（エラー/警告のみ）

ステータス: 適用済（CsvImportController/DashboardController/Parser/Repo/Service）。不足があれば個別対応。

---

## フェーズ1 完了報告（2025-09-21）

- 実施済み（No.1〜No.5）
  - No.1 Parser レガシー撤去: v2変換関数を完全撤去、v3正規化に一本化
  - No.2 Router/Controller 読込順: UMD/ESM混在の注意点を反映、現状順序で安定稼働
  - No.3 Database DTO 整備: 地域/通貨/金額/ティッカー/side を統一フォーマットに整備
  - No.4 エラーログ整備: 主要フローへ try/catch と日本語ログ、情報ログはデフォルト抑制
  - No.5 受け入れチェック: 符号規約/デデュープ/円フローを集計ログ出力

- 受け入れ基準（再確認）
  - JP/US/INVST 混在でプレビュー→保存→再取込（skipped）を確認
  - セクター配分チャート（v3経路）が表示（Exposureマスタ推定を導入）
  - Database 取引テーブルが v3 台帳由来のDTOで統一表示
  - コンソールに致命的エラーなし（SyntaxError/TypeError）
  - ドキュメント整合（設計/戦略/作業ログ）

- 参考ログ/資料
  - `docs/archive/作業ログ_2025-09-21_v3データ統合移行.md`
  - `docs/今後の開発戦略_投資ダッシュボードv2_2025-09-21.md`（v3反映済み）

フェーズ1は完了とし、次フェーズ（Phase 2: コア機能完成）へ移行します。
