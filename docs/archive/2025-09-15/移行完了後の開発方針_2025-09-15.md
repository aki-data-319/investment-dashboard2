# 投資ダッシュボード v2 - 移行完了後の開発方針

**作成日**: 2025年9月15日  
**対象プロジェクト**: 投資ダッシュボード v2 - ver1機能完全統合計画  
**現在の進捗**: Phase 1.2 基本統合完了（95%）→ Phase 2 高度機能移植へ

## 📊 現在の移行状況

### ✅ 完了済みコンポーネント
- **レイヤードアーキテクチャ基盤**: 100% 完成
- **UI Layer**: Dashboard/AssetForm/CsvImport の3画面実装済み
- **Business Layer**: AssetEntity/AssetCalculator 最適化完了
- **Data Layer**: DataStoreManager/AssetRepository 統合済み
- **基本ナビゲーション**: 3タブ対応Router.js実装済み
- **MVP版Services統合**: CSV取り込み基本機能実装済み

### 🔄 移行進捗度: **95%完了**
- 基本機能: 100% 完了
- アーキテクチャ移行: 100% 完了  
- ver1 Services基本統合: 90% 完了
- 高度分析機能: **5% 完了** ← **次の重点領域**
- テスト実装: 0% （Phase 3で対応）

---

## 🚀 Phase 2: データベースUI機能統合【最優先】

### **Phase 2.1 データベース機能の完全移植** (Week 1-2)
**目標**: 23版で実装済みのデータベースUI機能をv2アーキテクチャに完全統合

#### 🔥 **2.1.1 データベースページ基盤実装** (Day 1-2)
**移植元**: 23_investment-dashboard で Phase 3 Task 1-2として完了済み

**実装項目**:
```javascript
// 移植対象: 23版の完成済みデータベース機能
// src/ui/views/DatabaseView.js (新規作成)
// src/ui/controllers/DatabaseController.js (新規作成)

基盤機能:
- ナビゲーション機能（ダッシュボード⇔データベース切り替え）
- タブ形式UI（取引履歴・銘柄情報・編集履歴）
- レスポンシブデザイン対応
- 既存機能との完全な互換性維持
```

**技術仕様**:
- **UI層統合**: v2のレイヤードアーキテクチャに適合
- **状態管理**: Router.js拡張で4タブ目「Database」追加
- **データ連携**: 既存DataStoreManager/AssetRepository活用
- **互換性**: 既存3画面との完全な相互運用

#### 🔥 **2.1.2 取引履歴データベース完全実装** (Day 3-5)
**移植元**: 23版で Phase 3 Task 3として完了済み

**実装項目**:
```javascript
// 移植対象: 23版の完成済み取引履歴機能
// src/business/services/TransactionDatabaseService.js (新規作成)

取引履歴機能:
- 全取引データ統合表示（投資信託・個別株・仮想通貨）
- 高度フィルタリング（種別・地域・通貨・キーワード検索）
- 時系列表示・詳細情報表示・最新50件表示
- 既存詳細モーダルとの連携
- リアルタイム検索・動的フィルタリング
```

**データ処理強化**:
- **統合表示**: 全アセット種別の統一インターフェース
- **フィルタリング**: 4つの独立フィルター + キーワード検索
- **パフォーマンス**: 大量データでも高速レスポンス
- **連携**: 既存の詳細表示機能と完全連携

#### 🔥 **2.1.3 銘柄情報データベース実装** (Day 6-8)
**目標**: 23版で未完了だった銘柄管理機能を v2 で完成させる

**実装項目**:
```javascript
// 新規実装: 23版では Phase 3 Task 4として残作業だった機能
// src/business/services/AssetDatabaseService.js (新規作成)

銘柄管理機能:
- 銘柄別詳細情報管理画面
- セクター情報編集機能（東証33業種分類対応）
- パフォーマンス分析表示
- 銘柄統合・重複管理機能
- カスタム分類・タグ機能
```

**分析機能強化**:
- **セクター管理**: 既存SectorServiceとの完全統合
- **パフォーマンス分析**: 収益率・リスク指標表示
- **データ品質**: 重複検出・統合提案機能
- **カスタマイズ**: ユーザー独自の分類体系対応

#### 🔥 **2.1.4 専用CSS・レスポンシブデザイン完成** (Day 9-10)
**目標**: 23版で未完了だった専用スタイリングを v2 で完成

**実装項目**:
```css
// 新規作成: src/ui/styles/DatabaseView.css
// 23版では Phase 3 Task 5として残作業だった機能

スタイリング機能:
- データベースページ専用CSS
- レスポンシブデザイン（PC・タブレット・モバイル）
- ダークモード対応準備
- アクセシビリティ向上
- 高度なテーブル・カードレイアウト
```

**UX改善**:
- **操作性**: 直感的なナビゲーション・タブ切り替え
- **可読性**: 大量データの見やすい表示
- **パフォーマンス**: スムーズなアニメーション
- **一貫性**: 既存画面とのデザイン統一

---

### **Phase 2.2 データ処理精度の向上** (Week 2-3)
**目標**: 23版の精密なデータ処理機能をv2アーキテクチャに完全統合

#### 🔥 **2.2.1 RakutenCsvParser完全移植** (Day 1-3)
**現状**: 基本機能のみ実装→旧版の522行機能を完全移植

**実装項目**:
```javascript
// 移植対象: 23_investment-dashboard/src/services/rakutenCsvParser.js
// 対象行数: 522行 → v2/src/infrastructure/parsers/RakutenCsvParser.js

強化機能:
- Shift-JIS文字エンコーディング完全対応
- 28列(日本株)/18列(米国株)/14列(投資信託)の厳密マッピング
- CSV形式自動判定の精度向上
- エラーハンドリング・不正データ検出強化
- 楽天証券フォーマット変更への柔軟な対応
- パフォーマンス最適化（大量データ処理）
```

**技術仕様**:
- **文字エンコーディング**: Shift-JIS → UTF-8 完全対応
- **エラー処理**: 行別エラー詳細・修復提案機能
- **メモリ効率**: ストリーミング処理対応
- **互換性**: 楽天証券CSV形式のバージョン管理

#### 🔥 **2.2.2 PortfolioAggregator精度向上** (Day 4-6)
**現状**: 基本集約のみ→旧版の369行機能を完全移植

**実装項目**:
```javascript
// 移植対象: 23_investment-dashboard/src/services/portfolioAggregator.js  
// 対象行数: 369行 → v2/src/business/analysis/PortfolioAggregator.js

強化機能:
- 手数料・税金・為替の正確な計算処理
- 実現損益・未実現損益の厳密な分離
- 複数通貨対応（USD/JPY/その他）
- 配当金・分配金の自動計算
- 加重平均取得単価の精密計算
- 売買相殺処理の精度向上
```

**財務計算強化**:
- **損益計算**: 実現/未実現の厳密分離
- **為替処理**: 時点レート・平均レート対応
- **税務対応**: 源泉徴収・外国税額控除計算
- **配当管理**: 配当落ち・権利確定日考慮

#### 🔥 **2.2.3 SectorService完全拡充** (Day 7-10)  
**現状**: 簡易セクター付与のみ→旧版の425行機能を完全移植

**実装項目**:
```javascript
// 移植対象: 23_investment-dashboard/src/services/sectorManager.js
// 対象行数: 425行 → v2/src/business/services/SectorService.js

強化機能:
- 東証33業種分類の完全マスターデータ統合
- GICS（Global Industry Classification Standard）対応
- ETF・REIT・仮想通貨の特別分類処理
- HHI（ハーフィンダール・ハーシュマン指数）集中リスク分析
- 地域×セクターマトリックス分析
- カスタムセクター設定機能
- セクター配分の最適化提案
```

**マスターデータ強化**:
- **東証33業種**: 全上場企業の業種分類
- **GICS分類**: グローバル標準セクター分類
- **特別資産**: ETF/REIT/インフラファンド分類
- **地域分類**: 国別・地域別投資配分管理

---

### **Phase 2.3 セクター分析ダッシュボード実装** (Week 3-4)
**目標**: 新規画面「SectorAnalysisView」で高度セクター分析機能を提供

#### **2.3.1 SectorAnalysisView/Controller実装** (Day 1-5)
**新規画面追加**: ナビゲーション5タブ目（データベースの次）

**実装機能**:
```javascript
// 新規作成ファイル
src/ui/views/SectorAnalysisView.js       // セクター分析画面UI
src/ui/controllers/SectorAnalysisController.js  // セクター分析制御

画面構成:
1. セクター配分円グラフ（Chart.js）
2. 業種別パフォーマンス比較表
3. 地域×セクターマトリックス
4. HHI指数による集中リスク表示
5. リバランス提案パネル
```

#### **2.3.2 高度チャート機能実装** (Day 6-10)
**データ可視化強化**: Chart.js + カスタムチャート

**チャート種類**:
- **セクター配分円グラフ**: インタラクティブ・ドリルダウン対応
- **パフォーマンス比較**: 期間別・セクター別収益率
- **リスク分散マトリックス**: 相関係数・リスク寄与度
- **時系列推移**: セクター配分の変化追跡

---

### **Phase 2.4 ポートフォリオ分析強化** (Week 4-5)
**目標**: 新規画面「PortfolioAnalysisView」で詳細ポートフォリオ管理

#### **2.4.1 PortfolioAnalysisView/Controller実装** (Day 1-5)  
**新規画面追加**: ナビゲーション6タブ目

**実装機能**:
```javascript
// 新規作成ファイル  
src/ui/views/PortfolioAnalysisView.js       // ポートフォリオ分析画面
src/ui/controllers/PortfolioAnalysisController.js  // 分析制御

画面構成:
1. 銘柄別詳細一覧（楽天CSV統合表示）
2. 含み損益・実現損益の詳細分析
3. 取引履歴ベースの税務レポート  
4. パフォーマンストラッキング
5. ポートフォリオ最適化提案
```

#### **2.4.2 統合レポート機能** (Day 6-10)
**レポート生成**: 税務・パフォーマンス・リスク分析

**レポート種類**:
- **月次レポート**: 損益・配当・取引サマリー
- **年次レポート**: 確定申告用データ・税務計算
- **リスクレポート**: VaR・最大ドローダウン分析
- **パフォーマンスレポート**: ベンチマーク比較・寄与度分析

---

## 📅 詳細実装スケジュール

### **Week 1-2: データベースUI機能統合【最優先】**
```
Day 1-2:   データベースページ基盤実装
Day 3-5:   取引履歴データベース完全実装
Day 6-8:   銘柄情報データベース実装
Day 9-10:  専用CSS・レスポンシブデザイン完成
Day 11-12: データベース機能統合テスト・デバッグ
```

### **Week 2-3: データ処理精度向上**
```
Day 1-3:   RakutenCsvParser完全移植
Day 4-6:   PortfolioAggregator精度向上  
Day 7-10:  SectorService完全拡充
Day 11-12: データ処理機能統合テスト
```

### **Week 3-4: セクター分析機能**
```
Day 1-5:   SectorAnalysisView/Controller実装
Day 6-10:  高度チャート機能・データ可視化
Day 11-12: セクター分析機能統合テスト
```

### **Week 4-5: ポートフォリオ分析強化**  
```
Day 1-5:   PortfolioAnalysisView/Controller実装
Day 6-10:  統合レポート機能・税務対応
Day 11-12: 全機能統合テスト
```

---

## 🏗️ アーキテクチャ発展計画

### **現在のアーキテクチャ（v2レイヤード）**
```
src/
├── ui/                    # Presentation Layer
│   ├── views/            # 3画面（Dashboard/AssetForm/CsvImport）
│   ├── controllers/      # 3コントローラー
│   └── Router.js         # 3タブナビゲーション
├── business/             # Domain Layer  
│   ├── models/           # AssetEntity/AssetCalculator
│   ├── services/         # SectorService（簡易版）
│   └── analysis/         # PortfolioAggregator（簡易版）
├── data/                 # Data Access Layer
│   ├── repositories/     # AssetRepository
│   └── managers/         # DataStoreManager
├── infrastructure/       # Infrastructure Layer  
│   └── parsers/          # RakutenCsvParser（簡易版）
└── services/             # Application Layer
    ├── CsvImportService  # CSV取り込み統合
    └── PortfolioService  # ダッシュボード統合
```

### **Phase 2完了後のアーキテクチャ（完全統合版）**
```
src/
├── ui/                    # Presentation Layer
│   ├── views/            # 6画面（+Database/SectorAnalysis/PortfolioAnalysis）
│   │   ├── DatabaseView.js           # 🆕 データベースUI統合
│   │   ├── SectorAnalysisView.js     # セクター分析画面
│   │   └── PortfolioAnalysisView.js  # ポートフォリオ分析画面
│   ├── controllers/      # 6コントローラー
│   │   ├── DatabaseController.js     # 🆕 データベース管理制御
│   │   ├── SectorAnalysisController.js
│   │   └── PortfolioAnalysisController.js
│   ├── styles/          # 🆕 画面別CSS管理
│   │   └── DatabaseView.css         # データベース専用スタイル
│   └── Router.js         # 6タブナビゲーション（Database優先統合）
├── business/             # Domain Layer
│   ├── models/           # 拡張AssetEntity/AssetCalculator  
│   ├── services/         # 完全版SectorService + データベースサービス群
│   │   ├── TransactionDatabaseService.js  # 🆕 取引履歴管理
│   │   └── AssetDatabaseService.js        # 🆕 銘柄情報管理
│   └── analysis/         # 完全版PortfolioAggregator
├── data/                 # Data Access Layer
│   ├── repositories/     # 強化AssetRepository
│   └── managers/         # 完全版DataStoreManager
├── infrastructure/       # Infrastructure Layer
│   └── parsers/          # 完全版RakutenCsvParser
├── services/             # Application Layer
│   ├── CsvImportService  # 高精度CSV取り込み
│   ├── PortfolioService  # 高度分析機能統合
│   ├── DatabaseService              # 🆕 データベースUI統合サービス
│   ├── SectorAnalysisService        # セクター分析統合
│   └── ReportGenerationService      # レポート生成
└── utils/                # 🆕 共通ユーティリティ
    ├── ChartUtils.js     # チャート共通機能  
    ├── DateUtils.js      # 日付・時間処理
    └── FormatUtils.js    # データフォーマット
```

---

## 🎯 Phase 2 成功指標

### **技術指標**
- **データ処理精度**: CSV解析精度 99%以上
- **計算精度**: 財務計算（損益・税務）小数点以下2桁精度
- **パフォーマンス**: 1000件CSV処理 2秒以内
- **メモリ効率**: ピーク使用量 50MB以内

### **機能指標**  
- **画面数**: 6画面完全実装（Dashboard/AssetForm/CsvImport/Database/SectorAnalysis/PortfolioAnalysis）
- **データベース機能**: 取引履歴・銘柄情報・編集履歴の完全管理
- **フィルタリング**: 4つの独立フィルター + リアルタイム検索
- **チャート数**: 8種類以上の高度データ可視化
- **レポート数**: 4種類の統合レポート生成
- **マスターデータ**: 東証33業種 + GICS + 500銘柄以上対応

### **ユーザー体験指標**
- **操作応答性**: 全画面0.5秒以内応答
- **データ精度**: 楽天証券CSV → 分析結果の完全一致
- **使いやすさ**: 6タブ間スムーズ遷移・状態保持・直感的操作
- **データベース機能**: 高速検索・フィルタリング・インライン編集
- **実用性**: 確定申告対応・税務計算精度・データ管理効率性

---

## ⚠️ リスク管理・対策

### **技術的リスク**
1. **データ処理複雑化**: 高精度計算による処理速度低下
   - **対策**: 非同期処理・Web Workers活用・段階的読み込み
2. **メモリ消費増加**: 大量データ・複雑チャートによる負荷
   - **対策**: 仮想スクロール・データページング・メモリ監視
3. **UI複雑化**: 5画面管理による状態管理複雑化  
   - **対策**: Router.js強化・状態管理パターン統一

### **データ品質リスク**
1. **楽天CSV形式変更**: フォーマット変更による解析エラー
   - **対策**: 柔軟なマッピング・バージョン管理・フォールバック処理
2. **計算精度**: 複雑な財務計算での誤差蓄積
   - **対策**: 単体テスト・既知データでの検証・精度監視

### **開発リスク**
1. **スコープ拡大**: 機能追加による開発期間延長
   - **対策**: MVP優先・段階的リリース・明確な完了定義
2. **品質低下**: 高速開発による技術的負債蓄積
   - **対策**: 継続的リファクタリング・コードレビュー・自動テスト

---

## 🚦 Phase 3以降の展望

### **Phase 3: 品質強化・テスト実装** (Week 6-8)
- 統合テスト・自動テスト実装
- パフォーマンステスト・負荷テスト
- ユーザビリティテスト・UI/UX改善

### **Phase 4: 外部連携・高度機能** (Week 9+)  
- 他証券会社CSV対応
- 株価API連携・リアルタイムデータ
- AI/機械学習による投資提案

---

## 📋 推奨実装順序

### **今すぐ開始推奨**: 
**データベースページ基盤実装**（Phase 2.1.1）から着手し、23版の完成済みデータベース機能を最優先で統合することをお勧めします。

### **実装手順**:
1. **Week 1**: データベース機能完全統合（ページ基盤→取引履歴→銘柄情報→CSS）
2. **Week 2**: データ処理精度向上（RakutenCsvParser → PortfolioAggregator → SectorService）
3. **Week 3**: SectorAnalysisView実装・チャート機能
4. **Week 4**: PortfolioAnalysisView実装・レポート機能
5. **Week 5**: 全機能統合テスト・最終調整

---

## 🎉 最終目標

**Phase 2完了時には**、投資ダッシュボードv2が：
- ✅ 23版のデータベースUI機能を新アーキテクチャで完全実現
- ✅ 高度な取引履歴管理・銘柄情報データベース機能
- ✅ 楽天証券データの精密分析・レポート生成
- ✅ 6画面での包括的投資管理機能（Database機能優先統合）
- ✅ 確定申告対応・税務計算精度
- ✅ **実用的な個人投資家向けツールとして完成**

**真に価値のある投資管理プラットフォーム**として、旧版の優れた機能と新版の堅牢なアーキテクチャが融合した、次世代の投資ダッシュボードを実現します。