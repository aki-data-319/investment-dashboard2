# ãƒ‡ãƒ¼ã‚¿çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ - è¨­è¨ˆæ”¹å–„æ›¸ (v3)
**ä½œæˆæ—¥**: 2025-09-21  
**ç›®çš„**: æ¥½å¤©è¨¼åˆ¸ï¼ˆJPæ ª/USæ ª/æŠ•ä¿¡ï¼‰ãŠã‚ˆã³å°†æ¥ã®ä»–ç¤¾ã‚½ãƒ¼ã‚¹ï¼ˆä¾‹: Bybitï¼‰ã‚’ã€å˜ä¸€ã®å…±é€šã‚¹ã‚­ãƒ¼ãƒã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ¢ãƒ‡ãƒ«ã§çµ±åˆã—ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå…¨ä½“ã®ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸé…åˆ†ã‚’æ­£ç¢ºã«å¯è¦–åŒ–ã™ã‚‹ã€‚

---

## 1. ã‚´ãƒ¼ãƒ«ï¼ˆè¦ç‚¹ï¼‰
- **CSVå·®ç•°ã‚’Infrastructureã§å¸å**ã—ã€**Domainæ¨™æº–ã®TransactionEntity**ã¸çµ±ä¸€ã€‚
- **å…±é€šå°å¸³ï¼ˆtransactionsï¼‰**ã«**åŸé€šè²¨/å—æ¸¡/FX**ã‚’æ­£è¦åŒ–ã—ã¦ä¿å­˜ã€‚
- **æ ª=å˜ä¸€ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸã€æŠ•ä¿¡=åˆ†æ•£ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸ**ã‚’åŒä¸€ãƒ­ã‚¸ãƒƒã‚¯ã§é›†è¨ˆã§ãã‚‹**ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¬¡å…ƒãƒ¢ãƒ‡ãƒ«**ã‚’æ¡ç”¨ã€‚
- æ—¢å­˜APIã¯ç¶­æŒï¼ˆApplication/Businessã¯çµ±ä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§è¨ˆç®—ï¼‰ã€‚

---

## 2. ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆv3ï¼‰

### ğŸ¯ æ”¹å–„å¾Œã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
âœ… æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ•ãƒ­ãƒ¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”Œ Infrastructure Layer                     â”‚
â”‚ â”œâ”€â”€ RakutenCsvParser.js                     â”‚
â”‚ â”‚   â”œâ”€â”€ JP â†’ TransactionEntity               â”‚
â”‚ â”‚   â”œâ”€â”€ US â†’ TransactionEntity               â”‚
â”‚ â”‚   â””â”€â”€ INVST â†’ TransactionEntity            â”‚
â”‚ â””â”€â”€ [å…±é€šã®TransactionEntityã«çµ±ä¸€å¤‰æ›]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â¬‡ï¸ çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¼ Domain Layer (æ–°è¨­)                      â”‚
â”‚ â”œâ”€â”€ entities/                               â”‚
â”‚ â”‚   â”œâ”€â”€ TransactionEntity.js                â”‚
â”‚ â”‚   â”œâ”€â”€ AssetEntity.js                      â”‚
â”‚ â”‚   â””â”€â”€ PortfolioEntity.js                  â”‚
â”‚ â””â”€â”€ [ãƒ“ã‚¸ãƒã‚¹æ¦‚å¿µã®æ¨™æº–åŒ–å®šç¾©]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â¬‡ï¸ æ¨™æº–åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸª Data Layer                               â”‚
â”‚ â”œâ”€â”€ repositories/                           â”‚
â”‚ â”‚   â”œâ”€â”€ TransactionRepository.js            â”‚
â”‚ â”‚   â”œâ”€â”€ AssetRepository.js                  â”‚
â”‚ â”‚   â””â”€â”€ PortfolioRepository.js              â”‚
â”‚ â””â”€â”€ [çµ±ä¸€ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã§ç®¡ç†]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â¬‡ï¸ çµ±ä¸€ãƒ‡ãƒ¼ã‚¿ã§åˆ†æ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¼ Business Layer                           â”‚
â”‚ â”œâ”€â”€ PortfolioAggregator.js                  â”‚
â”‚ â”œâ”€â”€ SectorService.js                        â”‚
â”‚ â””â”€â”€ [çµ±ä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ç¢ºå®Ÿãªè¨ˆç®—]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å…±é€šã‚¹ã‚­ãƒ¼ãƒï¼ˆCanonical Transactionsï¼‰
**ãƒ†ãƒ¼ãƒ–ãƒ«: `transactions`ï¼ˆå°å¸³ãƒ»append-onlyï¼‰**

| åˆ—å | å‹ | å¿…é ˆ | èª¬æ˜ |
|---|---|---|---|
| `source` | TEXT | âœ”ï¸ | ãƒ‡ãƒ¼ã‚¿å…ƒï¼ˆ`rakuten`, `bybit` ãªã©ï¼‰ |
| `subtype` | TEXT | âœ”ï¸ | ç´°åˆ†é¡ï¼ˆ`jp_equity`, `us_equity`, `mutual_fund`, â€¦ï¼‰ |
| `trade_date` | DATE | âœ”ï¸ | ç´„å®šæ—¥ï¼ˆISOï¼‰ |
| `settle_date` | DATE |  | å—æ¸¡æ—¥ï¼ˆISOï¼‰ |
| `symbol` | TEXT |  | ãƒ†ã‚£ãƒƒã‚«ãƒ¼/éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ï¼ˆæŠ•ä¿¡ã¯NULLå¯ï¼‰ |
| `name` | TEXT | âœ”ï¸ | éŠ˜æŸ„å/ãƒ•ã‚¡ãƒ³ãƒ‰å |
| `market` | TEXT |  | å¸‚å ´åï¼ˆJP/US/FUNDç­‰ï¼‰ |
| `account_type` | TEXT |  | å£åº§ç¨®åˆ¥ï¼ˆç‰¹å®š/æ–°NISA/æ—§NISA ç­‰ï¼‰ |
| `trade_type` | TEXT | âœ”ï¸ | `buy`/`sell`/`dividend`/`interest`/`staking`/â€¦ |
| `margin_type` | TEXT |  | ä¿¡ç”¨åŒºåˆ†ï¼ˆç¾ç‰©/ä¿¡ç”¨ï¼‰ |
| `quantity` | DECIMAL(28,10) | âœ”ï¸ | æ•°é‡ï¼ˆæ ªæ•°/å£æ•°ï¼‰ |
| `quantity_unit` | TEXT | âœ”ï¸ | `æ ª`/`å£` |
| `price` | DECIMAL(28,10) |  | ç´„å®šå˜ä¾¡ï¼ˆ**åŸé€šè²¨**ï¼‰ |
| `price_currency` | CHAR(3) |  | å˜ä¾¡é€šè²¨ï¼ˆ`JPY`/`USD`/`USDT` ç­‰ï¼‰ |
| `gross_amount` | DECIMAL(28,10) |  | ç´„å®šä»£é‡‘ï¼ˆ**åŸé€šè²¨**ï¼‰ |
| `gross_currency` | CHAR(3) |  | ç´„å®šä»£é‡‘é€šè²¨ |
| `fee` | DECIMAL(28,10) |  | æ‰‹æ•°æ–™ |
| `tax` | DECIMAL(28,10) |  | ç¨é‡‘ |
| `other_costs` | DECIMAL(28,10) |  | è«¸è²»ç”¨ |
| `currency` | CHAR(3) | âœ”ï¸ | æ±ºæ¸ˆé€šè²¨ |
| `fx_rate` | DECIMAL(18,8) |  | ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼ˆå††/åŸé€šè²¨ï¼‰ |
| `settled_amount` | DECIMAL(28,10) | âœ”ï¸ | å—æ¸¡é‡‘é¡ï¼ˆ`settled_currency`å»ºã¦ã€**æµå…¥=æ­£/æµå‡º=è² **ï¼‰ |
| `settled_currency` | CHAR(3) | âœ”ï¸ | å—æ¸¡é€šè²¨ |
| `nisa` | TEXT |  | NISAåŒºåˆ† |
| `remarks` | JSON/TEXT |  | å‚™è€ƒï¼ˆæŠ•ä¿¡ãƒã‚¤ãƒ³ãƒˆç­‰ï¼‰ |
| `fingerprint` | CHAR(64) UNIQUE | âœ”ï¸ | é‡è¤‡æ’é™¤ã‚­ãƒ¼ï¼ˆåŒä¸€æ€§ãƒãƒªã‚·ãƒ¼ã«åŸºã¥ããƒãƒƒã‚·ãƒ¥ï¼‰ |

> ã“ã“ã¯ v2 ã®24åˆ—æ¡ˆã‚’ãƒ™ãƒ¼ã‚¹ã«ã€**ç¬¦å·è¦ç´„**ï¼ˆå—æ¸¡é‡‘é¡ï¼šæµå…¥=æ­£/æµå‡º=è² ï¼‰ã¨**é€šè²¨ã®æ„å‘³ï¼ˆåŸé€šè²¨ vs å—æ¸¡ï¼‰**ã‚’æ˜ç¤ºã€‚

---

## 4. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¬¡å…ƒãƒ¢ãƒ‡ãƒ«ï¼ˆã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸï¼‰
**ç›®çš„**: ã€Œæ ª=å˜ä¸€ã€ã€ŒæŠ•ä¿¡=åˆ†æ•£ã€ã‚’**åŒä¸€ãƒ­ã‚¸ãƒƒã‚¯**ã§åˆç®—ã—ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå…¨ä½“ã®é…åˆ†ã‚’ç®—å‡ºã€‚

### 4.1 ãƒã‚¹ã‚¿
- **`instruments`**ï¼ˆéŠ˜æŸ„ãƒ»ãƒ•ã‚¡ãƒ³ãƒ‰å°å¸³ï¼‰ï¼š`instrument_id`, `type`(`equity|etf|mutual_fund|crypto`), `symbol|isin|code`, `name`, `country_of_risk`, `sector_primary_id`, `currency`
- **`sectors`**ï¼š`sector_id`, `code`, `name`, `parent_sector_id?`ï¼ˆGICSç­‰ãƒ™ãƒ¼ã‚¹ã§OKï¼‰
- **`regions`**ï¼š`region_id`, `code`, `name`, `parent_region_id?`ï¼ˆCountryâ†’Regionéšå±¤ï¼‰

### 4.2 ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆé‡ã¿ï¼‰
- **`instrument_sector_exposure`**ï¼š`instrument_id`, `sector_id`, `weight`(0..1), `as_of`, `source(factsheet|manual|api)`, `quality(full|top10|estimate)`  
  - **æ ª**ï¼šå˜ä¸€è¡Œï¼ˆweight=1.0ï¼‰  
  - **æŠ•ä¿¡**ï¼šè¤‡æ•°è¡Œã®åˆè¨ˆ=1.0ï¼ˆtop10ã®ã¿ã®å ´åˆã¯æ®‹å·®ã‚’ `Unclassified` ã«ï¼‰
- **`instrument_region_exposure`**ï¼šåœ°åŸŸç‰ˆï¼ˆä¸Šã¨åŒæ§˜ï¼‰

> ï¼ˆæ‹¡å¼µï¼‰**`fund_holdings`**ï¼ˆãƒ•ã‚¡ãƒ³ãƒ‰â†’éŠ˜æŸ„ã®ä¿æœ‰ï¼‰ï¼š`fund_instrument_id`, `holding_instrument_id`, `weight`, `as_of` â€¦  
> â†’ ä¸‹ä½éŠ˜æŸ„ã®ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸã‹ã‚‰ã€ãƒ•ã‚¡ãƒ³ãƒ‰ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’**è‡ªå‹•åˆæˆ**ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã€‚

### 4.3 é›†è¨ˆå¼ï¼ˆè©•ä¾¡æ—¥ tï¼‰
- éŠ˜æŸ„ i ã®è©•ä¾¡é¡ã‚’ `Value_i`ï¼ˆå††ï¼‰ã€ã‚»ã‚¯ã‚¿ãƒ¼ s ã¸ã®é‡ã¿ã‚’ `Exposure_{i,s}` ã¨ã™ã‚‹ã¨ï¼š  
  \[ PortfolioSectorWeight(s) = \frac{\sum_i Value_i \times Exposure_{i,s}}{\sum_i Value_i} \]  
- åœ°åŸŸã‚‚åŒæ§˜ã€‚

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆæ¦‚ç•¥ï¼‰
1. **CSVå–è¾¼**ï¼ˆInfrastructureï¼‰: æ–‡å­—ã‚³ãƒ¼ãƒ‰/åˆ—å·®ç•°ã‚’å¸å â†’ **TransactionEntity[]** ã«æ­£è¦åŒ–  
2. **ä¿å­˜**ï¼ˆDataï¼‰: `transactions` ã« appendï¼ˆ`fingerprint` ã§ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—ï¼‰  
3. **ãƒã‚¸ã‚·ãƒ§ãƒ³ç”Ÿæˆ**ï¼ˆApplication/Businessï¼‰: transactions â†’ positionsï¼ˆè©•ä¾¡é¡ï¼‰  
4. **ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæˆ**ï¼ˆBusinessï¼‰: positions Ã— instrument_*_exposure â†’ ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸé…åˆ†  
5. **å¯è¦–åŒ–**ï¼ˆUIï¼‰: ãƒ‰ãƒ¼ãƒŠãƒ„/ãƒ„ãƒªãƒ¼/ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå¯„ä¸éŠ˜æŸ„/ãƒ•ã‚¡ãƒ³ãƒ‰ï¼‰

---

## 6. ãƒªãƒã‚¸ãƒˆãƒªå¥‘ç´„ï¼ˆæŠœç²‹ãƒ»TypeScriptï¼‰
```ts
type Side = 'BUY'|'SELL'|'DIVIDEND'|'INTEREST'|'STAKING'|'FEE'|'TRANSFER_IN'|'TRANSFER_OUT';

interface CanonicalTxn { /* 3ç« ã®åˆ—ã«å¯¾å¿œ */ }

interface TransactionRepository {
  upsertBatch(batchMeta: { source: string; subtype: string; fileHash: string; parserVersion: string; },
              txns: CanonicalTxn[],
              opts?: { dedupeBy?: 'fingerprint'|'external_trade_id' }): Promise<{ inserted: number; skipped: number; updated: number }>;
  listByDateRange(from: string, to: string): Promise<CanonicalTxn[]>;
}

interface ExposureRepository {
  getSectorExposure(instrumentId: string, asOf: string): Promise<Array<{ sectorId: string; weight: number }>>;
  getRegionExposure(instrumentId: string, asOf: string): Promise<Array<{ regionId: string; weight: number }>>;
}
```

---

## 7. å—ã‘å…¥ã‚ŒåŸºæº–ï¼ˆAcceptanceï¼‰
- JP/US/æŠ•ä¿¡ã®CSVæ··åœ¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ã€**ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆè¨ˆã®å††ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼**ãŒCSVã®åˆè¨ˆã«ä¸€è‡´ã€‚  
- å—æ¸¡é‡‘é¡ã®**ç¬¦å·ï¼ˆæµå…¥=æ­£/æµå‡º=è² ï¼‰**ãŒçµ±ä¸€ã€‚  
- æ ªã¯ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸ**weight=1.0**ã€æŠ•ä¿¡ã¯**åˆè¨ˆ=1.0**ï¼ˆä¸è¶³ã¯ `Unclassified` ã§å¯è¦–åŒ–ï¼‰ã€‚  
- åŒä¸€CSVã®å†å–è¾¼ã¯ **inserted=0 / skipped=n**ï¼ˆ`fingerprint` ã§ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—ï¼‰ã€‚  
- ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæ¯”ç‡ã¯**å¼ã©ãŠã‚Š**ã«å†ç¾ã€‚

---

## 8. ä»Šå¾Œã®æ‹¡å¼µ
- **ã‚¹ã‚¿ã‚¤ãƒ«/ã‚µã‚¤ã‚ºï¼ˆå¤§å‹/å°å‹ã€Value/Growthï¼‰**ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼è»¸è¿½åŠ ã€‚  
- **ãƒ•ã‚¡ãƒ³ãƒ‰ãƒ»ã‚ªãƒ–ãƒ»ãƒ•ã‚¡ãƒ³ã‚º**ã®å¤šæ®µãƒ«ãƒƒã‚¯ã‚¹ãƒ«ãƒ¼ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€‚  
- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®**é®®åº¦ï¼ˆas_ofï¼‰**ã«åŸºã¥ãè­¦å‘ŠUIãƒ»ä¿¡é ¼åº¦ã®å¯è¦–åŒ–ã€‚  
- å¤–éƒ¨APIï¼ˆfactsheet/ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ï¼‰å–ã‚Šè¾¼ã¿ã€‚

---

## 9. v2(æ”¹å–„æ›¸(2)) ã‹ã‚‰ã®å·®åˆ†ã¨æ”¹ä¿®å†…å®¹

### 9.1 æ¦‚å¿µãƒ»ãƒ¢ãƒ‡ãƒ«é¢ã®å·®åˆ†
- å…±é€šãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å°å¸³ã‚’å³å¯†åŒ–
  - åŸé€šè²¨ã¨å—æ¸¡é€šè²¨ã‚’åˆ†é›¢ã€ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ(`fx_rate`)ã‚’æ˜ç¤ºã€‚
  - å—æ¸¡é‡‘é¡ã®ç¬¦å·è¦ç´„ï¼ˆæµå…¥=æ­£/æµå‡º=è² ï¼‰ã‚’çµ±ä¸€ã€‚
  - `fingerprint` ã«ã‚ˆã‚‹åŒä¸€æ€§å®šç¾©ã¨ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—ã‚’å°å…¥ã€‚
- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¬¡å…ƒãƒ¢ãƒ‡ãƒ«ã‚’å°å…¥
  - æ ªã¯ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸã® weight=1.0ã€æŠ•ä¿¡ã¯è¤‡æ•°weightã®åˆè¨ˆ=1.0ã€‚
  - `instrument_*_exposure` ãƒ†ãƒ¼ãƒ–ãƒ«ã§é‡ã¿ã‚’ç®¡ç†ã—ã€åŒä¸€å¼ã§é…åˆ†ç®—å‡ºã€‚
- ãƒãƒ«ãƒã‚½ãƒ¼ã‚¹å‰æï¼ˆ`source`/`subtype`ï¼‰ã§ Bybit ç­‰ã®å°†æ¥æ‹¡å¼µã‚’å‰æåŒ–ã€‚

### 9.2 ãƒ¬ã‚¤ãƒ¤ãƒ¼è²¬å‹™ã®å…·ä½“åŒ–ï¼ˆv2ã®æŠ½è±¡â†’v3ã®å…·ä½“ï¼‰
- Infrastructure: CSVå·®ç•°å¸åâ†’TransactionEntity æ­£è¦åŒ–ã«åŠ ãˆã€ç¬¦å·ãƒ»é€šè²¨ãƒ»ç‚ºæ›¿ãƒ»æŒ‡ç´‹ç”Ÿæˆã¾ã§æ‹…ä¿ã€‚
- Domain: `TransactionEntity`/`AssetEntity`/å°†æ¥`PortfolioEntity`ã§ä¸å¤‰æ¡ä»¶ã‚’æ˜ç¤ºï¼ˆé€šè²¨æ•´åˆã€æ•°é‡>0 ç­‰ï¼‰ã€‚
- Data: `TransactionRepository.upsertBatch` ã‚’å®šç¾©ï¼ˆappend-onlyãƒ»æŒ‡ç´‹ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—ãƒ»ç¯„å›²å–å¾—ï¼‰ã€‚
- Business: positions ç”Ÿæˆâ†’exposure åˆæˆã®2æ®µæ§‹æˆã§é…åˆ†è¨ˆç®—ã‚’æ¨™æº–åŒ–ã€‚

### 9.3 å—ã‘å…¥ã‚ŒåŸºæº–ã®è¿½åŠ 
- å††ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ä¸€è‡´ã€ç¬¦å·çµ±ä¸€ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼é‡ã¿åˆè¨ˆã€å†å–è¾¼ã®æŒ™å‹•ã€æ•°å¼ã©ãŠã‚Šã®é…åˆ†å†ç¾ã‚’æ˜æ–‡åŒ–ã€‚

---

## 10. æ”¹ä¿®å¯¾è±¡ä¸€è¦§ï¼ˆå®Ÿè£…è¦³ç‚¹ï¼‰
- Infrastructure
  - RakutenCsvParser v3: åˆ—å·®ç•°å¸åï¼‹åŸé€šè²¨/å—æ¸¡/ç‚ºæ›¿/ç¬¦å·è¦ç´„/`fingerprint` ç”Ÿæˆã€‚
- Domain
  - `TransactionEntity` æ–°è¨­ï¼ˆv3ã‚¹ã‚­ãƒ¼ãƒæº–æ‹ ï¼‰
  - `AssetEntity` ç¶™ç¶šï¼ˆå¿…è¦ã«å¿œã˜ã¦é€šè²¨/åœ°åŸŸã®å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ–ï¼‰
- Data
  - `TransactionRepository.upsertBatch(meta, txns, { dedupeBy })`
  - `TransactionRepository.listByDateRange(from, to)`
  - `ExposureRepository.getSectorExposure(...) / getRegionExposure(...)`
- Business/Application
  - `positions` ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆåŠ é‡å¹³å‡åŸä¾¡ãƒ»å£²è²·ç›¸æ®ºãƒ»æ•°é‡/è©•ä¾¡é¡ï¼‰
  - `exposure` åˆæˆï¼ˆpositions Ã— instrument_*_exposureï¼‰
  - æ—¢å­˜ `SectorService` ã¯ exposure ãƒ™ãƒ¼ã‚¹ã¸ç§»è¡Œ

---

## 11. æ®µéšçš„ç§»è¡Œè¨ˆç”»ï¼ˆå„ªå…ˆåº¦ï¼‰
### Phase 1: å°å¸³ã®æ­£è¦åŒ–ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
1. Domain: `TransactionEntity` å®Ÿè£…ï¼ˆå¿…é ˆé …ç›®ãƒ»ä¸å¤‰æ¡ä»¶ï¼‰
2. Infra: RakutenCsvParser v3ï¼ˆé€šè²¨/ç‚ºæ›¿/ç¬¦å·/æŒ‡ç´‹ï¼‰
3. Data: TransactionRepository.upsertBatchï¼ˆappend-onlyãƒ»ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—ï¼‰

### Phase 2: åˆ†æã®æ¨™æº–åŒ–ï¼ˆä¸­å„ªå…ˆåº¦ï¼‰
1. positions ç”Ÿæˆï¼ˆè©•ä¾¡é¡/å¹³å‡åŸä¾¡/å®Ÿä¿æœ‰æŠ½å‡ºï¼‰
2. ExposureRepositoryï¼ˆç°¡æ˜“ãƒã‚¹ã‚¿ã‹ã‚‰å–å¾—ï¼‰
3. exposure åˆæˆã§ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸé…åˆ†ã‚’ç®—å‡ºï¼ˆå—ã‘å…¥ã‚ŒåŸºæº–ã«é©åˆï¼‰

### Phase 3: æ‹¡å¼µã¨å¯è¦–åŒ–ï¼ˆä½å„ªå…ˆåº¦ï¼‰
1. ãƒ•ã‚¡ãƒ³ãƒ‰ã®ãƒ«ãƒƒã‚¯ã‚¹ãƒ«ãƒ¼ï¼ˆholdingsâ†’exposure åˆæˆï¼‰
2. è¿½åŠ è»¸ï¼ˆã‚¹ã‚¿ã‚¤ãƒ«/ã‚µã‚¤ã‚ºï¼‰
3. UI ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå¯„ä¸éŠ˜æŸ„/ãƒ•ã‚¡ãƒ³ãƒ‰ã€å“è³ªãƒ»é®®åº¦è¡¨ç¤ºï¼‰

---

## 12. äº’æ›æ€§ã¨å½±éŸ¿ç¯„å›²
- æ—¢å­˜APIã¯ç¶­æŒã—ã€å†…éƒ¨çš„ã«çµ±ä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸ãƒãƒƒãƒ—ã€‚
- æ—§å–è¾¼ãƒ­ã‚¸ãƒƒã‚¯ã¯æ®µéšçš„ã« v3 å°å¸³ã¸ç§»è¡Œï¼ˆç§»è¡Œä¸­ã¯å¤‰æ›ã‚¢ãƒ€ãƒ—ã‚¿ã§æ©‹æ¸¡ã—ï¼‰ã€‚
- å†å–è¾¼æ™‚ã®å®‰å…¨æ€§ã¯ `fingerprint` ã§æ‹…ä¿ï¼ˆinserted=0 / skipped=nï¼‰ã€‚

---

## 13. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆæ–°è¦/æ”¹ä¿®ã®æ˜ç¤ºï¼‰

å‡¡ä¾‹: [NEW]=æ–°è¦, [MOD]=æ”¹ä¿®, [MOV]=ç§»å‹•, [DEL]=å‰Šé™¤ï¼ˆç§»å‹•ã«ä¼´ã†ï¼‰

```
src/
â”œâ”€ domain/                                   [NEW]
â”‚  â””â”€ entities/
â”‚     â”œâ”€ TransactionEntity.js                [NEW] v3ã‚¹ã‚­ãƒ¼ãƒæº–æ‹ ï¼ˆå°å¸³ï¼‰â‡¨ä½œã£ãŸã€‚
â”‚     â”œâ”€ AssetEntity.js                      [MOV] business/models ã‹ã‚‰ç§»å‹•ï¼ˆimportå…ˆå¤‰æ›´ï¼‰
â”‚     â””â”€ PortfolioEntity.js                  [NEW] å°†æ¥æ‹¡å¼µ
â”‚
â”œâ”€ infrastructure/
â”‚  â””â”€ parsers/
â”‚     â””â”€ RakutenCsvParser.js                 [MOD] åŸé€šè²¨/å—æ¸¡/FX/ç¬¦å·/æŒ‡ç´‹ç”Ÿæˆã«å¯¾å¿œï¼ˆv3ï¼‰
â”‚
â”œâ”€ data/
â”‚  â”œâ”€ managers/
â”‚  â”‚  â””â”€ DataStoreManager.js                 ï¼ˆç¾çŠ¶ç¶­æŒï¼‰
â”‚  â””â”€ repositories/
â”‚     â”œâ”€ TransactionRepository.js            [NEW] append-onlyå°å¸³ upsertBatch/dedup/list
â”‚     â”œâ”€ ExposureRepository.js               [NEW] ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¸ãƒ£ãƒ¼å–å¾—
â”‚     â””â”€ AssetRepository.js                  [MOD] AssetEntityã®æ–°ãƒ‘ã‚¹å‚ç…§ ç­‰
â”‚
â”œâ”€ business/
â”‚  â”œâ”€ analysis/
â”‚  â”‚  â””â”€ PortfolioAggregator.js              [MOD] positionsç”Ÿæˆâ†’exposureåˆæˆã®å°å…¥
â”‚  â”œâ”€ services/
â”‚  â”‚  â””â”€ SectorService.js                    [MOD] exposureãƒ™ãƒ¼ã‚¹é›†è¨ˆã¸ç§»è¡Œ
â”‚  â”œâ”€ validators/
â”‚  â”‚  â””â”€ AssetFormValidator.js               [MOD] Entityå‚ç…§ãƒ‘ã‚¹æ›´æ–°
â”‚  â””â”€ models/
â”‚     â”œâ”€ AssetCalculator.js                  [MOD] Entityå‚ç…§ãƒ‘ã‚¹æ›´æ–°
â”‚     â””â”€ AssetEntity.js                      [DEL] domain/entities ã¸ç§»å‹•
â”‚
â”œâ”€ services/
â”‚  â””â”€ CsvImportService.js                    [MOD] Parser v3/Transactionãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆ
â”‚
â”œâ”€ ui/
â”‚  â””â”€ controllers/
â”‚     â””â”€ AssetFormController.js              [MOD] Entityå‚ç…§ãƒ‘ã‚¹æ›´æ–°
```

è£œè¶³:
- æ—¢ã«é©ç”¨æ¸ˆã¿ã®å¤‰æ›´: `AssetEntity.js` ã® Domain ã¸ã®ç§»å‹•ã€ãŠã‚ˆã³å„æ‰€ã® import æ›´æ–°ã€‚
- ã“ã‚Œã‹ã‚‰å®Ÿè£…ã™ã‚‹ä¸»ãªæ–°è¦: `TransactionEntity.js`, `TransactionRepository.js`, `ExposureRepository.js` ã¨ Parser v3 ã®æ­£è¦åŒ–/æŒ‡ç´‹ç”Ÿæˆå¯¾å¿œã€‚

---

## 14. å®Ÿè£…é †åºï¼ˆè©³ç´°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰

ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãŸå…·ä½“çš„ãªå®Ÿè£…é †ã€‚å„ã‚¹ãƒ†ãƒƒãƒ—ã¯å°ã•ãªPRã«åˆ†å‰²å¯èƒ½ã€‚

ã€ç¾çŠ¶ã®é€²æ—ï¼ˆ2025-09-21ï¼‰ã€‘
- Domain
  - [æ¸ˆ] TransactionEntity å®Ÿè£…ï¼ˆå¿…é ˆé …ç›®ãƒ»ä¸å¤‰æ¡ä»¶ãƒ»ç¬¦å·è¦ç´„ãƒ˜ãƒ«ãƒ‘ãƒ»fingerprint ç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼‰
  - [æ¸ˆ] AssetEntity ã‚’ Domain ã«ç§»å‹•ï¼ˆå‚ç…§ãƒ‘ã‚¹æ›´æ–°ï¼‰
- Infrastructure
  - [æ¸ˆ] RakutenCsvParser: v2äº’æ›ã®ã¾ã¾ã€`useV3Transactions` ãƒ•ãƒ©ã‚°ã§ v3 TransactionEntity[] ã‚’åŒæ¢±è¿”å´ï¼ˆæš«å®šï¼‰
- Data
  - [æ¸ˆ] TransactionRepository å®Ÿè£…ï¼ˆappend-onlyã€fingerprint ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—ã€æœŸé–“å–å¾—ï¼‰
- Application
  - [æ¸ˆ] CsvImportService: v3ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å–ã‚Šå›ã—ãƒ»upsertBatch é€£çµãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ï¼ˆ`useV3Transactions` ã§åˆ‡æ›¿ã€æš«å®šï¼‰
- Business/UI
  - [æœª] positions ç”Ÿæˆãƒ»exposure åˆæˆãƒ»UIæ¥ç¶šï¼ˆä»Šå¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§å¯¾å¿œï¼‰

1) Domain: TransactionEntity ã®ã‚¹ã‚­ãƒ£ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ [NEW]
- æœ€å°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå¿…é ˆ: source, subtype, trade_date, trade_type, quantity, quantity_unit, currency, settled_amount, settled_currency, fingerprintï¼‰
- ä¸å¤‰æ¡ä»¶: æ•°é‡>0ã€é€šè²¨ã‚³ãƒ¼ãƒ‰3æ–‡å­—ã€ç¬¦å·è¦ç´„ï¼ˆsettled_amount: æµå…¥=æ­£/æµå‡º=è² ï¼‰
- ãƒ˜ãƒ«ãƒ‘: `static fromRaw(row, csvType)`ï¼ˆå°†æ¥ã®Parserã§åˆ©ç”¨ï¼‰

2) Infrastructure: RakutenCsvParser v3 æ”¹ä¿® [MOD]
- CSVå·®ç•°â†’TransactionEntity å¤‰æ›ï¼ˆåŸé€šè²¨/å—æ¸¡/ç‚ºæ›¿/ç¬¦å·ï¼‰
- `fingerprint` ç”Ÿæˆï¼ˆæ­£è¦åŒ–ã—ãŸã‚­ãƒ¼ã®ãƒãƒƒã‚·ãƒ¥ï¼‰
- äº’æ›: æ—¢å­˜ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼APIã¯ä¿æŒï¼ˆå¿…è¦ãªã‚‰ `useV3Transactions` ãƒ•ãƒ©ã‚°ã§åˆ‡æ›¿ï¼‰

3) Data: TransactionRepository å®Ÿè£… [NEW]
- `upsertBatch(meta, txns, { dedupeBy })`ï¼ˆappend-onlyã€æŒ‡ç´‹ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—ï¼‰
- `listByDateRange(from, to)`
- DataStoreManager ã‚’åˆ©ç”¨ï¼ˆåå‰ç©ºé–“: `investment-transactions`ï¼‰

4) Application: CsvImportService ã®æ¥ç¶š [MOD]
- Parser v3 ã‹ã‚‰ã® `TransactionEntity[]` ã‚’å—ã‘å–ã‚Šã€TransactionRepository.upsertBatch ã¸ä¿å­˜
- æ—§ãƒ•ãƒ­ãƒ¼ã¯ä¸€æ™‚çš„ã«æ®‹ã—ã€ãƒ•ãƒ©ã‚°ã§åˆ‡æ›¿ï¼ˆæ®µéšç§»è¡Œï¼‰

  4.1) v3å˜ä¸€åŒ–ï¼ˆãƒ•ãƒ©ã‚°æ’¤å»ï¼‰ã«å‘ã‘ãŸå„ªå…ˆèª¿æ•´
  - 4.1 Parserã‚’v3å°‚ç”¨ã«ã™ã‚‹ï¼ˆå³æ™‚ï¼‰
    - `parseCsvFile` ã®å‡ºåŠ›ã‚’ `entities: TransactionEntity[]` ã«ä¸€æœ¬åŒ–ï¼ˆ`data` ã¯å»ƒæ­¢ï¼‰
    - `useV3Transactions` ãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤
    - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨é€”ã«ã¯ `previewProjection(entities)` ã‚’æä¾›ï¼ˆUIãŒå¿…è¦ã¨ã™ã‚‹åˆ—ã¸å°„å½±ï¼‰
  - 4.2 CsvImportServiceã®ä¸€æœ¬åŒ–ï¼ˆå³æ™‚ï¼‰
    - ãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤ã—ã€å¸¸ã« Parser v3 ã‚’ä½¿ç”¨
    - `parseAndPreview` ã¯å†…éƒ¨ã§ `entities` â†’ `previewProjection` ã«å¤‰æ›ã—ã¦è¿”å´ï¼ˆäº’æ›ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ç¶­æŒï¼‰
    - æ—§ `importTransactions` ã¯éæ¨å¥¨åŒ–ã—ã€`parseImportV3` ã‚’æ­£è¦APIã«æ˜‡æ ¼ï¼ˆåç§°ã¯ `parseAndImport` ã«æ”¹åå¯ï¼‰
  - 4.3 å‘¼ã³å‡ºã—å´ã®æœ€å°ä¿®æ­£ï¼ˆå„ªå…ˆï¼‰
    - UI/ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãŒ `transactions` ã‚’å‚ç…§ã—ã¦ã„ã‚‹ç®‡æ‰€ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã® `previewProjection` ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ç½®æ›ï¼ˆå‘¼ã³å‡ºã—ã‚µã‚¤ãƒˆã¯å¤‰æ›´æœ€å°ï¼‰
  - 4.4 å—ã‘å…¥ã‚Œç¢ºèªï¼ˆç›´å¾Œï¼‰
    - JP/US/INVSTã®æ··åœ¨CSVã§ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ä¿å­˜ï¼ˆupsertBatchï¼‰ãŒæˆåŠŸã—ã€å†å–è¾¼ã¯skippedã¨ãªã‚‹ã“ã¨
  - 4.5 ãƒ¬ã‚¬ã‚·ãƒ¼å‰Šé™¤ï¼ˆå¾Œè¿½ã„ï¼‰
    - Parserã®v2å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã¨ `data` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€`useV3Transactions` ãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤
    - ã‚µãƒ¼ãƒ“ã‚¹ã®æ—§APIï¼ˆv2äº’æ›ï¼‰ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰æ’¤å»

  4.2) PreviewProjection ä»•æ§˜ï¼ˆUIæœ€å°å¤‰æ›´ã§ã®å°„å½±ï¼‰
  - ç›®çš„: UIã¯å¾“æ¥ã©ãŠã‚Š `{ transactions: Array<PreviewRow> }` ã‚’å—ã‘å–ã‚Šã€å†…éƒ¨ã§ã¯ v3 entities ã‚’å°„å½±
  - ç”Ÿæˆå…ƒ: TransactionEntity[]ï¼ˆentitiesï¼‰
  - å°„å½±å…ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆCsvImportView.showPreview ãŒå‚ç…§ï¼‰
    - executedAt â† `tradeDate`
    - market â† `market`ï¼ˆãªã‘ã‚Œã° `subtype` ã‚’ç°¡æ˜“è¡¨ç¤º: `jp_equity|us_equity|mutual_fund`ï¼‰
    - symbol â† `symbol || name`
    - side â† `tradeType`ï¼ˆ`buy|sell|dividend|...`ï¼‰
    - quantity â† `quantity`
    - price â† `price`ï¼ˆåŸé€šè²¨ã€‚USç­‰ã¯USDã®ã¾ã¾è¡¨ç¤ºï¼‰
    - amount â† `settledAmount`ï¼ˆå—æ¸¡é€šè²¨å»ºã¦ã€‚ç¬¦å·è¦ç´„æ¸ˆï¼‰
    - currency â† `settledCurrency`
  - å‚™è€ƒ
    - æ•°é‡/ä¾¡æ ¼/é‡‘é¡ã¯æ¡åŒºåˆ‡ã‚Šã‚„å›ºå®šå°æ•°ã¯UIå´ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å¯¾å¿œï¼ˆå¾“æ¥ã¨åŒç­‰ï¼‰
    - US/INVSTã®åŸé€šè²¨/å—æ¸¡é€šè²¨ã®é•ã„ã¯ `priceCurrency`/`settledCurrency` ã§åˆ¤åˆ¥å¯èƒ½

  4.3) v3å˜ä¸€åŒ– å®Ÿæ–½ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆUIæœ€å°å¤‰æ›´å«ã‚€ï¼‰
  1. Parser: v3å°‚ç”¨åŒ–ï¼ˆ`entities` ã®ã¿è¿”å´ã€`data` å‰Šé™¤ï¼‰
  2. Service: `parseAndPreview` ãŒ `preview: { transactions: PreviewRow[] }` ã‚’è¿”ã™ã‚ˆã†å†…éƒ¨ã§å°„å½±
  3. Controller/UI: æ—¢å­˜ã® `result.transactions` å‚ç…§ã‚’ãã®ã¾ã¾åˆ©ç”¨ï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´ä¸è¦ã¾ãŸã¯æœ€å°ï¼‰
  4. Service: `parseAndImport`ï¼ˆæ—§ `parseImportV3`ï¼‰ã‚’æ­£è¦APIã«ã—ã€å‘¼ã³å‡ºã—ã‚’ç§»è¡Œ
  5. å—ã‘å…¥ã‚Œ: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»¶æ•°ã€è¡¨è¡¨ç¤ºã€ä¿å­˜çµæœï¼ˆinserted/skippedï¼‰ã‚’ç¢ºèª
  6. ãƒ¬ã‚¬ã‚·ãƒ¼å‰Šé™¤: v2ãƒ­ã‚¸ãƒƒã‚¯/ãƒ•ãƒ©ã‚°/ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ’¤å»

  ã€æŠ€è¡“å¯å¦ï¼ˆå¯ï¼‰ã¨å½±éŸ¿ç¯„å›²ã€‘
  - æŠ€è¡“çš„ã«å¯èƒ½ã€‚ä¸»ãªå½±éŸ¿ã¯ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã¨å–è¾¼ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã€ã®ã¿ã§ã€æ—¢å­˜ã®Data/Business/UIã®å¤§åŠã¯éå½±éŸ¿ã€‚
  - äº’æ›ã®éµã¯ã€Œã‚µãƒ¼ãƒ“ã‚¹å±¤ã§å°„å½±ã‚’è¿”ã™ã€ã“ã¨ã€‚Parser/Domainã¯v3å°‚ç”¨ã«ã—ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
  - å…·ä½“å¯¾å¿œï¼ˆå„ªå…ˆé †ï¼‰:
    1) Parser: v3å°‚ç”¨åŒ–ï¼ˆentitiesã®ã¿è¿”å´ï¼‰+ previewProjectionãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£è¿½åŠ 
    2) Service: ãƒ•ãƒ©ã‚°ã‚’æ’¤å»ã—ã€`parseAndPreview` ãŒ projection ã‚’è¿”ã™ã‚ˆã†å†…éƒ¨å®Ÿè£…ã‚’æ›´æ–°
    3) Controller/UI: `transactions` å‚ç…§ã‚’ `preview.items` ç­‰ã®æ–°ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¸æœ€å°ç½®æ›
    4) å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆï¼ˆç¬¦å·è¦ç´„ãƒ»ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—ãƒ»å††ãƒ•ãƒ­ãƒ¼ä¸€è‡´ï¼‰ã§ç¢ºèª
    5) ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã¨ä¸è¦ã‚³ãƒ¼ãƒ‰å‰Šé™¤

5) Business: positions ç”Ÿæˆã®å°å…¥ [MOD]
- `PortfolioAggregator` ã« canonical transactions â†’ positionsï¼ˆæ•°é‡ãƒãƒƒãƒˆã€åŠ é‡å¹³å‡åŸä¾¡ã€è©•ä¾¡é¡ã®åŸºç¤ï¼‰ã‚’è¿½åŠ 
- æ—¢å­˜ã®ç°¡æ˜“é›†ç´„ã¯æ®‹ã—ã¤ã¤ã€æ–°ãƒ‘ã‚¹ã‚’å„ªå…ˆ

6) Data: ExposureRepository ã®æœ€å°å®Ÿè£… [NEW]
- equities: weight=1.0 ã®å›ºå®šãƒ«ãƒ¼ãƒ«
- mutual_fund: ç°¡æ˜“ãƒã‚¹ã‚¿/æ‰‹å‹•è¨­å®šã®weightsï¼ˆä¸è¶³ã¯ `Unclassified`ï¼‰

7) Business: exposure åˆæˆè¨ˆç®— [MOD]
- positions Ã— instrument_*_exposure ã§ã‚»ã‚¯ã‚¿ãƒ¼/åœ°åŸŸé…åˆ†ã‚’ç®—å‡º
- å—ã‘å…¥ã‚ŒåŸºæº–ã®å¼ã©ãŠã‚Šã«æ¤œè¨¼

8) Business: SectorService ç§»è¡Œ [MOD]
- æ—§ãƒ­ã‚¸ãƒƒã‚¯ã‹ã‚‰ exposure ãƒ™ãƒ¼ã‚¹ã¸ç½®æ›ï¼ˆäº’æ›APIç¶­æŒï¼‰

9) UI: å½±éŸ¿æœ€å°ã®æ¥ç¶šç¢ºèª [MOD]
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§é…åˆ†ãƒ»ã‚µãƒãƒªãƒ¼ãŒæ–°è¨ˆç®—ãƒ‘ã‚¹ã§å‡ºã‚‹ã“ã¨ã‚’ç¢ºèª

10) å—ã‘å…¥ã‚ŒåŸºæº–ãƒ†ã‚¹ãƒˆï¼ˆæ‰‹å‹•/ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰
- æ··åœ¨CSVã§ã®å††ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ä¸€è‡´ã€ç¬¦å·çµ±ä¸€ã€ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—å‹•ä½œã€é…åˆ†ã®å†ç¾æ€§

11) ãƒ•ãƒ©ã‚°æ’¤å»ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- `useV3Transactions` ã‚’æ—¢å®šONã«ã—æ—§ãƒ‘ã‚¹å‰Šé™¤ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

è£œè¶³ï¼ˆPRåˆ†å‰²ã‚¬ã‚¤ãƒ‰ï¼‰
- PR1: TransactionEntity è¿½åŠ ï¼ˆDomainï¼‰
- PR2: Parser v3 ã®æ­£è¦åŒ–ã¨æŒ‡ç´‹ï¼ˆInfrastructureï¼‰
- PR3: TransactionRepositoryï¼ˆDataï¼‰
- PR4: CsvImportService é€£çµï¼ˆApplicationï¼‰
- PR5: positions ç”Ÿæˆï¼ˆBusinessï¼‰
- PR6: ExposureRepository + exposure åˆæˆï¼ˆData/Businessï¼‰
- PR7: SectorService ã¨UIæœ€å°æ¥ç¶šï¼ˆBusiness/UIï¼‰
