# データ統合アーキテクチャ - 設計改善書 (v3)
**作成日**: 2025-09-21  
**目的**: 楽天証券（JP株/US株/投信）および将来の他社ソース（例: Bybit）を、単一の共通スキーマとエクスポージャーモデルで統合し、ポートフォリオ全体のセクター/地域配分を正確に可視化する。

---

## 1. ゴール（要点）
- **CSV差異をInfrastructureで吸収**し、**Domain標準のTransactionEntity**へ統一。
- **共通台帳（transactions）**に**原通貨/受渡/FX**を正規化して保存。
- **株=単一セクター/地域、投信=分散セクター/地域**を同一ロジックで集計できる**エクスポージャー次元モデル**を採用。
- 既存APIは維持（Application/Businessは統一フィールドで計算）。

---

## 2. レイヤードアーキテクチャ（v3）

### 🎯 改善後のアーキテクチャ

```
✅ 正しいデータ統合フロー
┌─────────────────────────────────────────────┐
│ 🔌 Infrastructure Layer                     │
│ ├── RakutenCsvParser.js                     │
│ │   ├── JP → TransactionEntity               │
│ │   ├── US → TransactionEntity               │
│ │   └── INVST → TransactionEntity            │
│ └── [共通のTransactionEntityに統一変換]     │
└─────────────────────────────────────────────┘
              ⬇️ 統一されたエンティティ
┌─────────────────────────────────────────────┐
│ 💼 Domain Layer (新設)                      │
│ ├── entities/                               │
│ │   ├── TransactionEntity.js                │
│ │   ├── AssetEntity.js                      │
│ │   └── PortfolioEntity.js                  │
│ └── [ビジネス概念の標準化定義]              │
└─────────────────────────────────────────────┘
              ⬇️ 標準化されたデータ
┌─────────────────────────────────────────────┐
│ 🏪 Data Layer                               │
│ ├── repositories/                           │
│ │   ├── TransactionRepository.js            │
│ │   ├── AssetRepository.js                  │
│ │   └── PortfolioRepository.js              │
│ └── [統一テーブル構造で管理]                │
└─────────────────────────────────────────────┘
              ⬇️ 統一データで分析
┌─────────────────────────────────────────────┐
│ 💼 Business Layer                           │
│ ├── PortfolioAggregator.js                  │
│ ├── SectorService.js                        │
│ └── [統一フィールドで確実な計算]            │
└─────────────────────────────────────────────┘
```

---

## 3. 共通スキーマ（Canonical Transactions）
**テーブル: `transactions`（台帳・append-only）**

| 列名 | 型 | 必須 | 説明 |
|---|---|---|---|
| `source` | TEXT | ✔︎ | データ元（`rakuten`, `bybit` など） |
| `subtype` | TEXT | ✔︎ | 細分類（`jp_equity`, `us_equity`, `mutual_fund`, …） |
| `trade_date` | DATE | ✔︎ | 約定日（ISO） |
| `settle_date` | DATE |  | 受渡日（ISO） |
| `symbol` | TEXT |  | ティッカー/銘柄コード（投信はNULL可） |
| `name` | TEXT | ✔︎ | 銘柄名/ファンド名 |
| `market` | TEXT |  | 市場名（JP/US/FUND等） |
| `account_type` | TEXT |  | 口座種別（特定/新NISA/旧NISA 等） |
| `trade_type` | TEXT | ✔︎ | `buy`/`sell`/`dividend`/`interest`/`staking`/… |
| `margin_type` | TEXT |  | 信用区分（現物/信用） |
| `quantity` | DECIMAL(28,10) | ✔︎ | 数量（株数/口数） |
| `quantity_unit` | TEXT | ✔︎ | `株`/`口` |
| `price` | DECIMAL(28,10) |  | 約定単価（**原通貨**） |
| `price_currency` | CHAR(3) |  | 単価通貨（`JPY`/`USD`/`USDT` 等） |
| `gross_amount` | DECIMAL(28,10) |  | 約定代金（**原通貨**） |
| `gross_currency` | CHAR(3) |  | 約定代金通貨 |
| `fee` | DECIMAL(28,10) |  | 手数料 |
| `tax` | DECIMAL(28,10) |  | 税金 |
| `other_costs` | DECIMAL(28,10) |  | 諸費用 |
| `currency` | CHAR(3) | ✔︎ | 決済通貨 |
| `fx_rate` | DECIMAL(18,8) |  | 為替レート（円/原通貨） |
| `settled_amount` | DECIMAL(28,10) | ✔︎ | 受渡金額（`settled_currency`建て、**流入=正/流出=負**） |
| `settled_currency` | CHAR(3) | ✔︎ | 受渡通貨 |
| `nisa` | TEXT |  | NISA区分 |
| `remarks` | JSON/TEXT |  | 備考（投信ポイント等） |
| `fingerprint` | CHAR(64) UNIQUE | ✔︎ | 重複排除キー（同一性ポリシーに基づくハッシュ） |

> ここは v2 の24列案をベースに、**符号規約**（受渡金額：流入=正/流出=負）と**通貨の意味（原通貨 vs 受渡）**を明示。

---

## 4. エクスポージャー次元モデル（セクター/地域）
**目的**: 「株=単一」「投信=分散」を**同一ロジック**で合算し、ポートフォリオ全体の配分を算出。

### 4.1 マスタ
- **`instruments`**（銘柄・ファンド台帳）：`instrument_id`, `type`(`equity|etf|mutual_fund|crypto`), `symbol|isin|code`, `name`, `country_of_risk`, `sector_primary_id`, `currency`
- **`sectors`**：`sector_id`, `code`, `name`, `parent_sector_id?`（GICS等ベースでOK）
- **`regions`**：`region_id`, `code`, `name`, `parent_region_id?`（Country→Region階層）

### 4.2 エクスポージャー（重み）
- **`instrument_sector_exposure`**：`instrument_id`, `sector_id`, `weight`(0..1), `as_of`, `source(factsheet|manual|api)`, `quality(full|top10|estimate)`  
  - **株**：単一行（weight=1.0）  
  - **投信**：複数行の合計=1.0（top10のみの場合は残差を `Unclassified` に）
- **`instrument_region_exposure`**：地域版（上と同様）

> （拡張）**`fund_holdings`**（ファンド→銘柄の保有）：`fund_instrument_id`, `holding_instrument_id`, `weight`, `as_of` …  
> → 下位銘柄のセクター/地域から、ファンドのエクスポージャーを**自動合成**することも可能。

### 4.3 集計式（評価日 t）
- 銘柄 i の評価額を `Value_i`（円）、セクター s への重みを `Exposure_{i,s}` とすると：  
  \[ PortfolioSectorWeight(s) = \frac{\sum_i Value_i \times Exposure_{i,s}}{\sum_i Value_i} \]  
- 地域も同様。

---

## 5. データフロー（概略）
1. **CSV取込**（Infrastructure）: 文字コード/列差異を吸収 → **TransactionEntity[]** に正規化  
2. **保存**（Data）: `transactions` に append（`fingerprint` でデデュープ）  
3. **ポジション生成**（Application/Business）: transactions → positions（評価額）  
4. **エクスポージャー合成**（Business）: positions × instrument_*_exposure → セクター/地域配分  
5. **可視化**（UI）: ドーナツ/ツリー/ドリルダウン（寄与銘柄/ファンド）

---

## 6. リポジトリ契約（抜粋・TypeScript）
```ts
type Side = 'BUY'|'SELL'|'DIVIDEND'|'INTEREST'|'STAKING'|'FEE'|'TRANSFER_IN'|'TRANSFER_OUT';

interface CanonicalTxn { /* 3章の列に対応 */ }

interface TransactionRepository {
  upsertBatch(batchMeta: { source: string; subtype: string; fileHash: string; parserVersion: string; },
              txns: CanonicalTxn[],
              opts?: { dedupeBy?: 'fingerprint'|'external_trade_id' }): Promise<{ inserted: number; skipped: number; updated: number }>;
  listByDateRange(from: string, to: string): Promise<CanonicalTxn[]>;
}

interface ExposureRepository {
  getSectorExposure(instrumentId: string, asOf: string): Promise<Array<{ sectorId: string; weight: number }>>;
  getRegionExposure(instrumentId: string, asOf: string): Promise<Array<{ regionId: string; weight: number }>>;
}
```

---

## 7. 受け入れ基準（Acceptance）
- JP/US/投信のCSV混在インポートで、**プレビュー合計の円キャッシュフロー**がCSVの合計に一致。  
- 受渡金額の**符号（流入=正/流出=負）**が統一。  
- 株はセクター/地域**weight=1.0**、投信は**合計=1.0**（不足は `Unclassified` で可視化）。  
- 同一CSVの再取込は **inserted=0 / skipped=n**（`fingerprint` でデデュープ）。  
- セクター/地域のポートフォリオ比率は**式どおり**に再現。

---

## 8. 今後の拡張
- **スタイル/サイズ（大型/小型、Value/Growth）**のエクスポージャー軸追加。  
- **ファンド・オブ・ファンズ**の多段ルックスルーとキャッシュ。  
- エクスポージャーの**鮮度（as_of）**に基づく警告UI・信頼度の可視化。  
- 外部API（factsheet/ホールディングス）取り込み。

---

## 9. v2(改善書(2)) からの差分と改修内容

### 9.1 概念・モデル面の差分
- 共通トランザクション台帳を厳密化
  - 原通貨と受渡通貨を分離、為替レート(`fx_rate`)を明示。
  - 受渡金額の符号規約（流入=正/流出=負）を統一。
  - `fingerprint` による同一性定義とデデュープを導入。
- エクスポージャー次元モデルを導入
  - 株はセクター/地域の weight=1.0、投信は複数weightの合計=1.0。
  - `instrument_*_exposure` テーブルで重みを管理し、同一式で配分算出。
- マルチソース前提（`source`/`subtype`）で Bybit 等の将来拡張を前提化。

### 9.2 レイヤー責務の具体化（v2の抽象→v3の具体）
- Infrastructure: CSV差異吸収→TransactionEntity 正規化に加え、符号・通貨・為替・指紋生成まで担保。
- Domain: `TransactionEntity`/`AssetEntity`/将来`PortfolioEntity`で不変条件を明示（通貨整合、数量>0 等）。
- Data: `TransactionRepository.upsertBatch` を定義（append-only・指紋デデュープ・範囲取得）。
- Business: positions 生成→exposure 合成の2段構成で配分計算を標準化。

### 9.3 受け入れ基準の追加
- 円キャッシュフロー一致、符号統一、エクスポージャー重み合計、再取込の挙動、数式どおりの配分再現を明文化。

---

## 10. 改修対象一覧（実装観点）
- Infrastructure
  - RakutenCsvParser v3: 列差異吸収＋原通貨/受渡/為替/符号規約/`fingerprint` 生成。
- Domain
  - `TransactionEntity` 新設（v3スキーマ準拠）
  - `AssetEntity` 継続（必要に応じて通貨/地域の値オブジェクト化）
- Data
  - `TransactionRepository.upsertBatch(meta, txns, { dedupeBy })`
  - `TransactionRepository.listByDateRange(from, to)`
  - `ExposureRepository.getSectorExposure(...) / getRegionExposure(...)`
- Business/Application
  - `positions` 生成パイプライン（加重平均原価・売買相殺・数量/評価額）
  - `exposure` 合成（positions × instrument_*_exposure）
  - 既存 `SectorService` は exposure ベースへ移行

---

## 11. 段階的移行計画（優先度）
### Phase 1: 台帳の正規化（高優先度）
1. Domain: `TransactionEntity` 実装（必須項目・不変条件）
2. Infra: RakutenCsvParser v3（通貨/為替/符号/指紋）
3. Data: TransactionRepository.upsertBatch（append-only・デデュープ）

### Phase 2: 分析の標準化（中優先度）
1. positions 生成（評価額/平均原価/実保有抽出）
2. ExposureRepository（簡易マスタから取得）
3. exposure 合成でセクター/地域配分を算出（受け入れ基準に適合）

### Phase 3: 拡張と可視化（低優先度）
1. ファンドのルックスルー（holdings→exposure 合成）
2. 追加軸（スタイル/サイズ）
3. UI ドリルダウン（寄与銘柄/ファンド、品質・鮮度表示）

---

## 12. 互換性と影響範囲
- 既存APIは維持し、内部的に統一フィールドへマップ。
- 旧取込ロジックは段階的に v3 台帳へ移行（移行中は変換アダプタで橋渡し）。
- 再取込時の安全性は `fingerprint` で担保（inserted=0 / skipped=n）。

---

## 13. ディレクトリ構成（新規/改修の明示）

凡例: [NEW]=新規, [MOD]=改修, [MOV]=移動, [DEL]=削除（移動に伴う）

```
src/
├─ domain/                                   [NEW]
│  └─ entities/
│     ├─ TransactionEntity.js                [NEW] v3スキーマ準拠（台帳）⇨作った。
│     ├─ AssetEntity.js                      [MOV] business/models から移動（import先変更）
│     └─ PortfolioEntity.js                  [NEW] 将来拡張
│
├─ infrastructure/
│  └─ parsers/
│     └─ RakutenCsvParser.js                 [MOD] 原通貨/受渡/FX/符号/指紋生成に対応（v3）
│
├─ data/
│  ├─ managers/
│  │  └─ DataStoreManager.js                 （現状維持）
│  └─ repositories/
│     ├─ TransactionRepository.js            [NEW] append-only台帳 upsertBatch/dedup/list
│     ├─ ExposureRepository.js               [NEW] セクター/地域エクスポージャー取得
│     └─ AssetRepository.js                  [MOD] AssetEntityの新パス参照 等
│
├─ business/
│  ├─ analysis/
│  │  └─ PortfolioAggregator.js              [MOD] positions生成→exposure合成の導入
│  ├─ services/
│  │  └─ SectorService.js                    [MOD] exposureベース集計へ移行
│  ├─ validators/
│  │  └─ AssetFormValidator.js               [MOD] Entity参照パス更新
│  └─ models/
│     ├─ AssetCalculator.js                  [MOD] Entity参照パス更新
│     └─ AssetEntity.js                      [DEL] domain/entities へ移動
│
├─ services/
│  └─ CsvImportService.js                    [MOD] Parser v3/Transactionパイプライン統合
│
├─ ui/
│  └─ controllers/
│     └─ AssetFormController.js              [MOD] Entity参照パス更新
```

補足:
- 既に適用済みの変更: `AssetEntity.js` の Domain への移動、および各所の import 更新。
- これから実装する主な新規: `TransactionEntity.js`, `TransactionRepository.js`, `ExposureRepository.js` と Parser v3 の正規化/指紋生成対応。

---

## 14. 実装順序（詳細チェックリスト）

依存関係を考慮した具体的な実装順。各ステップは小さなPRに分割可能。

【現状の進捗（2025-09-21）】
- Domain
  - [済] TransactionEntity 実装（必須項目・不変条件・符号規約ヘルパ・fingerprint 生成ユーティリティ）
  - [済] AssetEntity を Domain に移動（参照パス更新）
- Infrastructure
  - [済] RakutenCsvParser: v2互換のまま、`useV3Transactions` フラグで v3 TransactionEntity[] を同梱返却（暫定）
- Data
  - [済] TransactionRepository 実装（append-only、fingerprint デデュープ、期間取得）
- Application
  - [済] CsvImportService: v3エンティティ取り回し・upsertBatch 連結メソッドを追加（`useV3Transactions` で切替、暫定）
- Business/UI
  - [未] positions 生成・exposure 合成・UI接続（今後のステップで対応）

1) Domain: TransactionEntity のスキャフォールド [NEW]
- 最小フィールド（必須: source, subtype, trade_date, trade_type, quantity, quantity_unit, currency, settled_amount, settled_currency, fingerprint）
- 不変条件: 数量>0、通貨コード3文字、符号規約（settled_amount: 流入=正/流出=負）
- ヘルパ: `static fromRaw(row, csvType)`（将来のParserで利用）

2) Infrastructure: RakutenCsvParser v3 改修 [MOD]
- CSV差異→TransactionEntity 変換（原通貨/受渡/為替/符号）
- `fingerprint` 生成（正規化したキーのハッシュ）
- 互換: 既存プレビューAPIは保持（必要なら `useV3Transactions` フラグで切替）

3) Data: TransactionRepository 実装 [NEW]
- `upsertBatch(meta, txns, { dedupeBy })`（append-only、指紋デデュープ）
- `listByDateRange(from, to)`
- DataStoreManager を利用（名前空間: `investment-transactions`）

4) Application: CsvImportService の接続 [MOD]
- Parser v3 からの `TransactionEntity[]` を受け取り、TransactionRepository.upsertBatch へ保存
- 旧フローは一時的に残し、フラグで切替（段階移行）

  4.1) v3単一化（フラグ撤去）に向けた優先調整
  - 4.1 Parserをv3専用にする（即時）
    - `parseCsvFile` の出力を `entities: TransactionEntity[]` に一本化（`data` は廃止）
    - `useV3Transactions` フラグを削除
    - プレビュー用途には `previewProjection(entities)` を提供（UIが必要とする列へ射影）
  - 4.2 CsvImportServiceの一本化（即時）
    - フラグを削除し、常に Parser v3 を使用
    - `parseAndPreview` は内部で `entities` → `previewProjection` に変換して返却（互換インタフェース維持）
    - 旧 `importTransactions` は非推奨化し、`parseImportV3` を正規APIに昇格（名称は `parseAndImport` に改名可）
  - 4.3 呼び出し側の最小修正（優先）
    - UI/コントローラが `transactions` を参照している箇所は、サービスからの `previewProjection` を参照するように置換（呼び出しサイトは変更最小）
  - 4.4 受け入れ確認（直後）
    - JP/US/INVSTの混在CSVで、プレビュー・保存（upsertBatch）が成功し、再取込はskippedとなること
  - 4.5 レガシー削除（後追い）
    - Parserのv2変換ロジックと `data` フィールド、`useV3Transactions` フラグを削除
    - サービスの旧API（v2互換）をドキュメントから撤去

  4.2) PreviewProjection 仕様（UI最小変更での射影）
  - 目的: UIは従来どおり `{ transactions: Array<PreviewRow> }` を受け取り、内部では v3 entities を射影
  - 生成元: TransactionEntity[]（entities）
  - 射影先フィールド（CsvImportView.showPreview が参照）
    - executedAt ← `tradeDate`
    - market ← `market`（なければ `subtype` を簡易表示: `jp_equity|us_equity|mutual_fund`）
    - symbol ← `symbol || name`
    - side ← `tradeType`（`buy|sell|dividend|...`）
    - quantity ← `quantity`
    - price ← `price`（原通貨。US等はUSDのまま表示）
    - amount ← `settledAmount`（受渡通貨建て。符号規約済）
    - currency ← `settledCurrency`
  - 備考
    - 数量/価格/金額は桁区切りや固定小数はUI側フォーマットで対応（従来と同等）
    - US/INVSTの原通貨/受渡通貨の違いは `priceCurrency`/`settledCurrency` で判別可能

  4.3) v3単一化 実施チェックリスト（UI最小変更含む）
  1. Parser: v3専用化（`entities` のみ返却、`data` 削除）
  2. Service: `parseAndPreview` が `preview: { transactions: PreviewRow[] }` を返すよう内部で射影
  3. Controller/UI: 既存の `result.transactions` 参照をそのまま利用（コード変更不要または最小）
  4. Service: `parseAndImport`（旧 `parseImportV3`）を正規APIにし、呼び出しを移行
  5. 受け入れ: プレビュー件数、表表示、保存結果（inserted/skipped）を確認
  6. レガシー削除: v2ロジック/フラグ/ドキュメントを撤去

  【技術可否（可）と影響範囲】
  - 技術的に可能。主な影響は「プレビュー表示と取込ユースケース」のみで、既存のData/Business/UIの大半は非影響。
  - 互換の鍵は「サービス層で射影を返す」こと。Parser/Domainはv3専用にして問題ありません。
  - 具体対応（優先順）:
    1) Parser: v3専用化（entitiesのみ返却）+ previewProjectionユーティリティ追加
    2) Service: フラグを撤去し、`parseAndPreview` が projection を返すよう内部実装を更新
    3) Controller/UI: `transactions` 参照を `preview.items` 等の新プロパティへ最小置換
    4) 受け入れテスト（符号規約・デデュープ・円フロー一致）で確認
    5) ドキュメント更新と不要コード削除

5) Business: positions 生成の導入 [MOD]
- `PortfolioAggregator` に canonical transactions → positions（数量ネット、加重平均原価、評価額の基礎）を追加
- 既存の簡易集約は残しつつ、新パスを優先

6) Data: ExposureRepository の最小実装 [NEW]
- equities: weight=1.0 の固定ルール
- mutual_fund: 簡易マスタ/手動設定のweights（不足は `Unclassified`）

7) Business: exposure 合成計算 [MOD]
- positions × instrument_*_exposure でセクター/地域配分を算出
- 受け入れ基準の式どおりに検証

8) Business: SectorService 移行 [MOD]
- 旧ロジックから exposure ベースへ置換（互換API維持）

9) UI: 影響最小の接続確認 [MOD]
- ダッシュボードで配分・サマリーが新計算パスで出ることを確認

10) 受け入れ基準テスト（手動/スクリプト）
- 混在CSVでの円キャッシュフロー一致、符号統一、デデュープ動作、配分の再現性

11) フラグ撤去とクリーンアップ
- `useV3Transactions` を既定ONにし旧パス削除、ドキュメント更新

補足（PR分割ガイド）
- PR1: TransactionEntity 追加（Domain）
- PR2: Parser v3 の正規化と指紋（Infrastructure）
- PR3: TransactionRepository（Data）
- PR4: CsvImportService 連結（Application）
- PR5: positions 生成（Business）
- PR6: ExposureRepository + exposure 合成（Data/Business）
- PR7: SectorService とUI最小接続（Business/UI）
