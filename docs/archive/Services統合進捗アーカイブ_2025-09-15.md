# ver1 Services統合 進捗アーカイブ - 2025-09-15

対象: 投資ダッシュボード v2 / Phase 1.2 改良版（レイヤード最適化）

## サマリー
- 目的: 参照版services（DataManager, RakutenCsvParser, SectorManager, PortfolioAggregator）をv2へ段階統合。
- 結果: UI遷移〜CSV取込MVPまで一通り実装。データ層はDataStoreManagerへ委譲化。
- 状態: 機能MVP達成（旧版の高度機能は未移植）。動線と基盤は完成。

## 追加/変更ファイル一覧

### Data Layer
- 追加: `src/data/managers/DataStoreManager.js`
  - 永続化抽象（save/load/remove/listKeys）
  - バージョン管理（get/setVersion）、マイグレーション枠
  - バックアップ/リストア（namespace配下の一括処理）
- 更新: `src/data/repositories/AssetRepository.js`
  - 直接Adapter → `DataStoreManager` 委譲へ置換
  - 公開APIを維持（getAll/add/update/delete/summary 等）

### Infrastructure Layer
- 追加: `src/infrastructure/parsers/RakutenCsvParser.js`
  - PapaParseベースのJP/US/投信 CSV→TransactionDTO 変換（簡易ヘッダ判定）
- 追記: `public/index.html`（PapaParse CDN）

### Business Layer
- 追加: `src/business/analysis/PortfolioAggregator.js`
  - 取引履歴→銘柄別集約（買付加算/売却相殺/加重平均）
- 追加: `src/business/services/SectorService.js`
  - セクター付与（symbol/keyword）・セクター別集計
- 追加: `src/business/data/sectors.master.json`
  - 最小マスター
- 互換性: `src/business/models/AssetEntity.js`
  - 旧インスタンス呼び出し互換の軽量実装を追加
  - `getUnrealizedGainLoss() / getReturnPercentage() / getSummary()`

### Services Layer
- 追加: `src/services/CsvImportService.js`
  - パース→集約→セクター付与→AssetEntity生成→Repository保存
  - `parseAndPreview()` / `importTransactions({dedupe,dryRun})`
- 追加: `src/services/PortfolioService.js`
  - ダッシュボード用サマリー/配分/ランキングの編成（最小）

### UI Layer
- 追加: `src/ui/views/CsvImportView.js`（新画面: CSV取り込み）
- 追加: `src/ui/controllers/CsvImportController.js`
- 変更: `src/ui/Router.js` に `#import-csv` ルートを登録

## レイヤ統合状況（参照版との対応）
- DataManager → DataStoreManager: 基本機能移植。マイグレーション手順は枠のみ。
- RakutenCsvParser: 簡易マッピングを実装。Shift-JISや全列網羅は未対応。
- PortfolioAggregator: 基本集約（平均法/相殺）のみ移植。
- SectorManager → SectorService: 簡易付与/集計を実装。フルマスタやHHI等は未。

## 既知の未実装/差分
- CSVエンコーディング/列網羅/エラー詳細（旧版相当の厳密度には未到達）
- 集約のFX/手数料/実現損益/複通貨の厳密処理
- セクター: 東証33/GICSフルマスタ、ETF/REIT特則、HHI/分散指標
- Data移行: 具体的マイグレーション手順
- 最小テスト（Parser/Aggregator）

## 動作確認メモ（MVP）
1) 画面遷移: ナビゲーションの「CSV取り込み」タブ or `#import-csv`
2) プレビュー: CSVをD&D→プレビュー→先頭10件/件数/警告表示
3) オプション: 重複スキップ/ドライラン（dryRunで保存なし件数検証）
4) インポート: 実行→結果表示→ダッシュボード更新（自動）

## 推奨次ステップ
- Parser強化: Shift‑JIS/列バージョン対応、厳密エラー設計
- Aggregator強化: 手数料/FX/実現損益/複通貨
- Sector拡充: マスタ投入、HHI/マトリクス
- Data移行: migrate()手順の具体化＋バックアップ同梱
- PortfolioServiceへ集約処理の本格移行（Repositoryの責務軽減）
- 単体テスト（Parser/Aggregator/Sector）

## 付録: 追加ファイルツリー
```
src/
├─ business/
│  ├─ analysis/PortfolioAggregator.js
│  ├─ services/SectorService.js
│  └─ data/sectors.master.json
├─ data/
│  ├─ managers/DataStoreManager.js
│  └─ repositories/AssetRepository.js  // 内部委譲化
├─ infrastructure/
│  └─ parsers/RakutenCsvParser.js
├─ services/
│  ├─ CsvImportService.js
│  └─ PortfolioService.js
└─ ui/
   ├─ controllers/CsvImportController.js
   ├─ views/CsvImportView.js
   └─ Router.js                   // import-csv 追加
```

---
このアーカイブは、Phase 1.2 改良版のMVP統合スナップショットです。以降は精度強化（Parser/Aggregator/Sector）とData移行手順の具体化を優先します。

