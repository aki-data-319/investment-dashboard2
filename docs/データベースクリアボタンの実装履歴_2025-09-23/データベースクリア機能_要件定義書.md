# データベースクリア機能 要件定義書

**作成日**: 2025-09-23  
**対象バージョン**: Investment Dashboard v2  
**作成者**: Claude Code  

## 概要

データベースページにデータクリア（全削除）機能を追加し、ユーザーが保存されている投資データを安全にリセットできる機能の要件を定義します。

## 1. 背景・課題

### 1.1 現在の状況
- DataStoreManagerに`clearAllData()`メソッドが既に実装済み
- データベースページは3つのタブ（取引履歴・銘柄情報・編集履歴）を持つ
- UIレベルでのクリア機能が提供されていない
- ユーザーがテストデータやデモデータをリセットしたい場合の手段がない

### 1.2 ユーザーニーズ
- **開発・テスト目的**: サンプルデータの削除とクリーンスタート
- **間違ったデータ入力の修正**: 大量の誤ったデータを一括削除
- **プライバシー保護**: 他人に見せる際の個人データ削除
- **アプリリセット**: 最初から投資記録をやり直したい

### 1.3 リスク・課題
- **データ消失の危険性**: 誤操作による重要データの永久削除
- **復元不可能性**: 一度削除されたデータは復旧できない
- **ユーザビリティ**: 安全な操作性と十分な警告の両立

## 2. 機能要件

### 2.1 基本機能要件

#### F1. データクリア機能
- **F1.1**: 全投資データ（投資信託・個別株・仮想通貨・取引履歴）の一括削除
- **F1.2**: DataStoreManagerの`clearAllData()`メソッドを活用
- **F1.3**: 削除対象データの事前プレビュー表示
- **F1.4**: 削除実行後の完了確認メッセージ

#### F2. 安全性機能
- **F2.1**: 複数段階の確認ダイアログ
- **F2.2**: データ削除前の最終確認（テキスト入力による意思確認）
- **F2.3**: 削除処理中のキャンセル不可仕様
- **F2.4**: 削除完了後のページ自動リフレッシュ

#### F3. ユーザーインターフェース
- **F3.1**: データベースページ内の専用クリアボタン
- **F3.2**: 危険性を示すビジュアルデザイン（赤色系統）
- **F3.3**: 削除対象データの数量・種別表示
- **F3.4**: 処理進捗の視覚的フィードバック

#### F4. データプレビュー機能
- **F4.1**: 削除前の保存データサマリー表示
- **F4.2**: 各データ種別の件数表示
- **F4.3**: 最終更新日時の表示
- **F4.4**: データサイズ情報の表示

### 2.2 非機能要件

#### N1. セキュリティ・安全性
- **N1.1**: 誤操作防止のための多重確認
- **N1.2**: 確認テキスト入力による意図的操作の担保
- **N1.3**: 処理実行権限の制限（適切なユーザーのみ）

#### N2. ユーザビリティ
- **N2.1**: 削除の危険性を明確に伝えるUI
- **N2.2**: 段階的な確認プロセスによる十分な検討時間
- **N2.3**: キャンセル操作の容易性（最終段階まで）

#### N3. パフォーマンス
- **N3.1**: 削除処理は5秒以内に完了
- **N3.2**: 大量データでも安定した処理
- **N3.3**: 処理中のUI応答性維持

#### N4. 信頼性
- **N4.1**: 削除処理の完全性（部分削除の防止）
- **N4.2**: エラー時の適切なメッセージ表示
- **N4.3**: 処理中断時の状態管理

## 3. ユーザーインタラクション設計

### 3.1 基本操作フロー

```
1. データベースページにアクセス
   ↓
2. 「データベースクリア」ボタンをクリック
   ↓
3. 【第1段階】警告ダイアログ表示
   - 削除される内容の説明
   - 「続行」「キャンセル」選択
   ↓
4. 【第2段階】データプレビュー表示
   - 保存されているデータの詳細
   - データ種別ごとの件数
   - 「削除実行」「キャンセル」選択
   ↓
5. 【第3段階】最終確認
   - 確認テキスト入力「DELETE」
   - 「完全削除実行」「キャンセル」選択
   ↓
6. 削除処理実行
   - プログレス表示
   - キャンセル不可
   ↓
7. 完了確認とページリフレッシュ
```

### 3.2 確認ダイアログの詳細設計

#### 第1段階: 基本警告
```
⚠️ データベース全削除の警告

この操作により、保存されている全ての投資データが
完全に削除されます。

【削除されるデータ】
• 投資信託情報
• 個別株情報  
• 仮想通貨情報
• 取引履歴
• 編集履歴

⚠️ 一度削除されたデータは復元できません

[続行] [キャンセル]
```

#### 第2段階: データプレビュー
```
📊 削除対象データの確認

現在保存されているデータ:
┌─────────────────────────┐
│ 投資信託:     15件       │
│ 個別株:       8件        │
│ 仮想通貨:     3件        │
│ 取引履歴:     142件      │
│ データサイズ: 125KB      │
│ 最終更新:     2025-09-23 │
└─────────────────────────┘

⚠️ これらのデータが全て削除されます

[削除実行] [キャンセル]
```

#### 第3段階: 最終確認
```
🔴 最終確認 - データ完全削除

本当にすべてのデータを削除しますか？
この操作は取り消しできません。

削除を実行するには、下記に「DELETE」と入力してください:

[_________________]

⚠️ データは完全に失われ、復元不可能です

[完全削除実行] [キャンセル]
```

## 4. UI・UX仕様

### 4.1 ボタン配置・デザイン

#### データベースページ内の配置
- **位置**: データベースページヘッダー右端
- **外観**: 赤色背景、白文字、警告アイコン付き
- **サイズ**: 中程度（目立つが誤クリックしにくい）
- **ラベル**: "🗑️ データベースクリア"

#### 安全性を示すデザイン要素
- **色使い**: 危険性を示す赤色系統
- **アイコン**: 警告・削除を示すアイコン
- **レイアウト**: 他機能と明確に分離
- **ホバー効果**: より強い警告色に変化

### 4.2 モーダルデザイン

#### 共通仕様
- **背景**: 半透明オーバーレイ
- **サイズ**: 中央固定、適切な読みやすいサイズ
- **閉じる方法**: ESCキー、オーバーレイクリック（最終段階除く）
- **アニメーション**: スムーズなフェードイン・アウト

#### 段階別カスタマイズ
- **第1段階**: 標準的な警告デザイン
- **第2段階**: データ表示に特化したレイアウト
- **第3段階**: 最高レベルの警告デザイン、赤い枠線

### 4.3 プログレス表示

#### 削除処理中の表示
```
🗑️ データ削除中...

[████████████████████████] 100%

処理中はブラウザを閉じないでください
完了まで約5秒お待ちください
```

#### 完了表示
```
✅ データ削除完了

すべてのデータが正常に削除されました。
ページを更新して初期状態に戻ります。

[OK]
```

## 5. 技術仕様

### 5.1 実装対象ファイル

#### 新規作成ファイル
- なし（既存ファイルの修正のみ）

#### 修正対象ファイル
1. **DatabaseView.js** - クリアボタンとモーダルUI追加
2. **DatabaseController.js** - クリア処理の制御ロジック追加
3. **DatabaseView.css** - クリア機能用スタイル追加

### 5.2 既存システムとの連携

#### DataStoreManager.clearAllData()の活用
```javascript
// 既存メソッドの仕様
clearAllData() {
    // 全データキーを削除
    // 成功/失敗の真偽値を返却
    // コンソールログ出力
}
```

#### Router.jsとの連携
- 削除完了後のページリフレッシュ
- ナビゲーション状態の初期化

### 5.3 データ削除の範囲

#### 削除対象（DataStoreManager.STORAGE_KEYS）
```javascript
STORAGE_KEYS = {
    mutualFunds: 'investment_mutual_funds',     // 投資信託データ
    stocks: 'investment_stocks',                // 個別株データ
    cryptoAssets: 'investment_crypto_assets',   // 仮想通貨データ
    assetHistory: 'investment_asset_history',   // 資産履歴データ
    simpleHistory: 'investment_simple_history'  // 変更履歴データ
}
```

#### 削除非対象
- アプリケーション設定
- ユーザー設定
- ブラウザの基本情報

## 6. エラーハンドリング

### 6.1 想定エラーケース

#### E1. LocalStorage容量不足・アクセスエラー
- **症状**: localStorage.removeItem()が失敗
- **対処**: エラーメッセージ表示、手動ブラウザキャッシュクリア案内

#### E2. 部分削除失敗
- **症状**: 一部データのみ削除、一部残存
- **対処**: 失敗したキーの再削除試行、手動確認案内

#### E3. 処理中断（ブラウザ終了など）
- **症状**: 削除処理の不完全終了
- **対処**: 次回起動時の整合性チェック、残存データ確認

### 6.2 エラーメッセージ設計

#### LocalStorageエラー
```
❌ データ削除エラー

LocalStorageへのアクセスに失敗しました。
ブラウザの設定を確認してください。

【対処方法】
1. ブラウザのプライベートモードを解除
2. サイトの許可設定を確認
3. ブラウザキャッシュをクリア

[再試行] [キャンセル]
```

#### 部分削除エラー
```
⚠️ 一部データの削除に失敗

以下のデータが残っている可能性があります:
• 投資信託データ
• 取引履歴データ

手動での確認をお勧めします。

[詳細確認] [閉じる]
```

## 7. テスト要件

### 7.1 機能テスト項目

#### 基本機能テスト
- [ ] クリアボタンの表示・動作
- [ ] 3段階確認ダイアログの表示
- [ ] 確認テキスト入力の検証
- [ ] データ削除処理の実行
- [ ] 削除完了後のページ状態

#### データ削除テスト
- [ ] 全データ種別の完全削除
- [ ] LocalStorageの空状態確認
- [ ] ダッシュボードでの空状態表示

#### エラーハンドリングテスト
- [ ] LocalStorageアクセス拒否時
- [ ] 処理中断時の状態
- [ ] 部分削除失敗時の処理

### 7.2 ユーザビリティテスト

#### 安全性テスト
- [ ] 誤操作の防止効果
- [ ] 確認プロセスの分かりやすさ
- [ ] キャンセル操作の容易性

#### 操作性テスト
- [ ] モーダルの見やすさ
- [ ] ボタンの押しやすさ
- [ ] 警告の理解しやすさ

## 8. 成功指標

### 8.1 機能的成功指標
- ✅ データ削除成功率: 100%
- ✅ UI応答性: 1秒以内
- ✅ エラー回復率: 95%以上

### 8.2 ユーザビリティ指標
- ✅ 誤操作防止率: 95%以上
- ✅ 確認プロセス完了率: 90%以上
- ✅ ユーザー理解度: 4.0/5.0以上

### 8.3 安全性指標
- ✅ 意図しない削除の発生率: 0%
- ✅ 確認プロセス迂回率: 0%
- ✅ データ復旧要求: 0件

## 9. 制約事項

### 9.1 技術的制約
- LocalStorageの容量制限（約5-10MB）
- ブラウザのセキュリティポリシー
- JavaScript実行環境への依存

### 9.2 機能制約
- データ復元機能は提供しない
- バックアップ機能は対象外
- 部分削除機能は提供しない

### 9.3 ユーザビリティ制約
- 確認プロセスの迂回不可
- 削除処理中のキャンセル不可
- ブラウザ依存の動作差異

---

**実装方針**: 安全性を最優先とし、多重確認による誤操作防止を徹底した上で、シンプルで分かりやすいユーザーインターフェースを提供する。