# データベースクリア機能 実装計画書

**作成日**: 2025-09-23  
**対象バージョン**: Investment Dashboard v2  
**作成者**: Claude Code  

## 概要

データベースページにデータクリア機能を追加するための詳細な実装手順を示します。既存のDataStoreManager.clearAllData()メソッドを活用し、安全性を重視した3段階確認プロセスを実装します。

## 1. 実装アーキテクチャ

### 1.1 修正対象ファイル

```
src/
├── ui/
│   ├── views/
│   │   └── DatabaseView.js          【修正】クリアボタンとモーダル追加
│   ├── controllers/
│   │   └── DatabaseController.js    【修正】クリア処理制御ロジック追加
│   └── styles/
│       └── DatabaseView.css         【修正】クリア機能用スタイル追加
```

### 1.2 実装方針

#### 基本設計原則
- **安全性最優先**: 3段階確認による誤操作防止
- **既存システム活用**: DataStoreManager.clearAllData()の利用
- **最小限の修正**: 既存コードへの影響を最小化
- **視覚的フィードバック**: ユーザーに明確な状況提示

#### アーキテクチャ連携
- **View層**: UI表示・ユーザー操作の受け付け
- **Controller層**: 処理制御・DataStoreManagerとの連携
- **Data層**: 既存のDataStoreManager.clearAllData()を活用

## 2. 詳細実装手順

### Phase 1: DatabaseView.js の修正

#### Step 1.1: クリアボタンの追加

**ファイル**: `src/ui/views/DatabaseView.js`

**修正箇所**: `render()`メソッド内のdatabase-headerセクション

**修正内容**:

```javascript
// 【修正】render()メソッド内のheaderセクション
render() {
    return `
        <div id="databasePage" class="page-content database-page page-enter">
            <div class="database-header">
                <h1>🗂️ 投資データベース</h1>
                <div class="navigation-actions">
                    <button onclick="router.showDashboard()" class="btn-back" title="ダッシュボードに戻る">
                        ← ダッシュボードに戻る
                    </button>
                    <!-- 【追加】データベースクリアボタン -->
                    <button id="databaseClearBtn" class="btn-database-clear" title="全データを削除">
                        🗑️ データベースクリア
                    </button>
                </div>
                
                <!-- 既存のタブ部分は変更なし -->
                <div class="database-tabs">
                    <!-- ... 既存のタブボタン ... -->
                </div>
            </div>
            
            <!-- 既存のコンテンツ部分は変更なし -->
            <div class="database-content">
                <!-- ... 既存のタブコンテンツ ... -->
            </div>
            
            <!-- 【追加】クリア機能用モーダル -->
            <div id="clearConfirmModal" class="modal-overlay clear-modal" style="display: none;">
                <div class="modal-dialog clear-dialog">
                    <div id="clearModalContent" class="modal-content">
                        <!-- 動的に生成されるコンテンツ -->
                    </div>
                </div>
            </div>
            
            <!-- 既存の編集モードインジケーター -->
            <div id="editModeIndicator" class="edit-mode-indicator" style="display: none;">
                ✏️ 編集モード有効
            </div>
        </div>
    `;
}
```

#### Step 1.2: モーダル表示メソッドの追加

**修正内容**: DatabaseViewクラスに以下のメソッドを追加

```javascript
/**
 * 【追加】データクリア確認モーダルを表示
 * @param {number} stage - 確認段階（1-3）
 * @param {Object} [data={}] - 表示データ
 */
showClearConfirmModal(stage, data = {}) {
    const modal = document.getElementById('clearConfirmModal');
    const content = document.getElementById('clearModalContent');
    
    if (!modal || !content) return;
    
    // 段階別コンテンツ生成
    const modalHtml = this.#generateClearModalContent(stage, data);
    content.innerHTML = modalHtml;
    
    // モーダル表示
    modal.style.display = 'flex';
    modal.classList.add('modal-active');
    
    // イベントリスナー設定
    this.#bindClearModalEvents(stage);
    
    // ESCキー対応（最終段階以外）
    if (stage < 3) {
        this.#setupEscapeHandler();
    }
}

/**
 * 【追加】クリア確認モーダルを非表示
 */
hideClearConfirmModal() {
    const modal = document.getElementById('clearConfirmModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('modal-active');
    }
    
    // ESCハンドラー解除
    document.removeEventListener('keydown', this.escapeHandler);
}

/**
 * 【追加】段階別モーダルコンテンツ生成
 * @param {number} stage - 確認段階
 * @param {Object} data - データ
 * @returns {string} モーダルHTML
 * @private
 */
#generateClearModalContent(stage, data) {
    switch (stage) {
        case 1:
            return this.#generateStage1Content();
        case 2:
            return this.#generateStage2Content(data);
        case 3:
            return this.#generateStage3Content();
        case 4:
            return this.#generateProgressContent(data);
        case 5:
            return this.#generateCompletionContent(data);
        default:
            return '<p>エラー: 不正な段階です</p>';
    }
}

/**
 * 【追加】第1段階: 基本警告コンテンツ
 * @returns {string} HTML
 * @private
 */
#generateStage1Content() {
    return `
        <div class="clear-modal-header warning-header">
            <h2 class="modal-title">
                <i class="icon-warning">⚠️</i>
                データベース全削除の警告
            </h2>
            <button class="modal-close-btn" data-action="cancel">
                <i class="icon-close">✕</i>
            </button>
        </div>
        
        <div class="clear-modal-body">
            <div class="warning-message">
                <p class="warning-text">
                    この操作により、保存されている<strong>全ての投資データ</strong>が
                    完全に削除されます。
                </p>
                
                <div class="deletion-list">
                    <h4>【削除されるデータ】</h4>
                    <ul>
                        <li>📈 投資信託情報</li>
                        <li>📊 個別株情報</li>
                        <li>💰 仮想通貨情報</li>
                        <li>📋 取引履歴</li>
                        <li>📝 編集履歴</li>
                    </ul>
                </div>
                
                <div class="critical-warning">
                    <p>⚠️ <strong>一度削除されたデータは復元できません</strong></p>
                </div>
            </div>
        </div>
        
        <div class="clear-modal-footer">
            <button class="btn btn-secondary" data-action="cancel">
                キャンセル
            </button>
            <button class="btn btn-warning" data-action="continue">
                続行
            </button>
        </div>
    `;
}

/**
 * 【追加】第2段階: データプレビューコンテンツ
 * @param {Object} data - データ統計
 * @returns {string} HTML
 * @private
 */
#generateStage2Content(data) {
    const {
        mutualFunds = 0,
        stocks = 0,
        cryptoAssets = 0,
        transactions = 0,
        dataSize = 0,
        lastUpdate = '不明'
    } = data;

    return `
        <div class="clear-modal-header data-header">
            <h2 class="modal-title">
                <i class="icon-data">📊</i>
                削除対象データの確認
            </h2>
            <button class="modal-close-btn" data-action="cancel">
                <i class="icon-close">✕</i>
            </button>
        </div>
        
        <div class="clear-modal-body">
            <div class="data-preview">
                <p class="preview-intro">現在保存されているデータ:</p>
                
                <div class="data-summary">
                    <div class="data-item">
                        <span class="data-label">投資信託:</span>
                        <span class="data-value">${mutualFunds}件</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">個別株:</span>
                        <span class="data-value">${stocks}件</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">仮想通貨:</span>
                        <span class="data-value">${cryptoAssets}件</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">取引履歴:</span>
                        <span class="data-value">${transactions}件</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">データサイズ:</span>
                        <span class="data-value">${this.#formatDataSize(dataSize)}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">最終更新:</span>
                        <span class="data-value">${lastUpdate}</span>
                    </div>
                </div>
                
                <div class="warning-emphasis">
                    <p>⚠️ <strong>これらのデータが全て削除されます</strong></p>
                </div>
            </div>
        </div>
        
        <div class="clear-modal-footer">
            <button class="btn btn-secondary" data-action="cancel">
                キャンセル
            </button>
            <button class="btn btn-danger" data-action="execute">
                削除実行
            </button>
        </div>
    `;
}

/**
 * 【追加】第3段階: 最終確認コンテンツ
 * @returns {string} HTML
 * @private
 */
#generateStage3Content() {
    return `
        <div class="clear-modal-header final-header">
            <h2 class="modal-title">
                <i class="icon-danger">🔴</i>
                最終確認 - データ完全削除
            </h2>
        </div>
        
        <div class="clear-modal-body">
            <div class="final-confirmation">
                <p class="final-warning">
                    <strong>本当にすべてのデータを削除しますか？</strong><br>
                    この操作は取り消しできません。
                </p>
                
                <div class="confirmation-input">
                    <label for="confirmationText">
                        削除を実行するには、下記に「<strong>DELETE</strong>」と入力してください:
                    </label>
                    <input 
                        type="text" 
                        id="confirmationText" 
                        class="confirmation-input-field"
                        placeholder="DELETE と入力"
                        autocomplete="off"
                    >
                </div>
                
                <div class="final-warning-emphasis">
                    <p>⚠️ <strong>データは完全に失われ、復元不可能です</strong></p>
                </div>
            </div>
        </div>
        
        <div class="clear-modal-footer">
            <button class="btn btn-secondary" data-action="cancel">
                キャンセル
            </button>
            <button class="btn btn-danger" data-action="final-execute" disabled>
                完全削除実行
            </button>
        </div>
    `;
}

/**
 * 【追加】進捗表示コンテンツ
 * @param {Object} data - 進捗データ
 * @returns {string} HTML
 * @private
 */
#generateProgressContent(data) {
    const { progress = 0, message = '削除中...' } = data;
    
    return `
        <div class="clear-modal-header progress-header">
            <h2 class="modal-title">
                <i class="icon-progress">🗑️</i>
                データ削除中...
            </h2>
        </div>
        
        <div class="clear-modal-body">
            <div class="progress-display">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <p class="progress-message">${message}</p>
                <p class="progress-warning">
                    処理中はブラウザを閉じないでください<br>
                    完了まで約5秒お待ちください
                </p>
            </div>
        </div>
    `;
}

/**
 * 【追加】完了表示コンテンツ
 * @param {Object} data - 完了データ
 * @returns {string} HTML
 * @private
 */
#generateCompletionContent(data) {
    const { success = true, message = 'データ削除完了' } = data;
    
    return `
        <div class="clear-modal-header success-header">
            <h2 class="modal-title">
                <i class="icon-success">${success ? '✅' : '❌'}</i>
                ${message}
            </h2>
        </div>
        
        <div class="clear-modal-body">
            <div class="completion-message">
                ${success ? `
                    <p>すべてのデータが正常に削除されました。<br>
                    ページを更新して初期状態に戻ります。</p>
                ` : `
                    <p>データ削除中にエラーが発生しました。<br>
                    一部のデータが残っている可能性があります。</p>
                `}
            </div>
        </div>
        
        <div class="clear-modal-footer">
            <button class="btn btn-primary" data-action="close">
                OK
            </button>
        </div>
    `;
}

/**
 * 【追加】モーダルイベント設定
 * @param {number} stage - 確認段階
 * @private
 */
#bindClearModalEvents(stage) {
    // 基本的なボタンイベント
    const modal = document.getElementById('clearConfirmModal');
    modal.addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        if (action) {
            this.#handleClearModalAction(action, stage);
        }
    });
    
    // 第3段階の特別処理
    if (stage === 3) {
        this.#setupFinalConfirmationInput();
    }
}

/**
 * 【追加】最終確認入力の設定
 * @private
 */
#setupFinalConfirmationInput() {
    const input = document.getElementById('confirmationText');
    const executeBtn = document.querySelector('[data-action="final-execute"]');
    
    if (input && executeBtn) {
        input.addEventListener('input', (e) => {
            const isValid = e.target.value.trim().toUpperCase() === 'DELETE';
            executeBtn.disabled = !isValid;
            executeBtn.classList.toggle('btn-enabled', isValid);
        });
        
        // Enterキーでの実行
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !executeBtn.disabled) {
                this.#handleClearModalAction('final-execute', 3);
            }
        });
    }
}

/**
 * 【追加】ESCキーハンドラー設定
 * @private
 */
#setupEscapeHandler() {
    this.escapeHandler = (e) => {
        if (e.key === 'Escape') {
            this.hideClearConfirmModal();
        }
    };
    document.addEventListener('keydown', this.escapeHandler);
}

/**
 * 【追加】モーダルアクション処理
 * @param {string} action - アクション種別
 * @param {number} stage - 現在の段階
 * @private
 */
#handleClearModalAction(action, stage) {
    // DatabaseControllerに処理を委譲
    if (window.databaseController) {
        window.databaseController.handleClearAction(action, stage);
    }
}

/**
 * 【追加】データサイズフォーマット
 * @param {number} bytes - バイト数
 * @returns {string} フォーマット済み文字列
 * @private
 */
#formatDataSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
```

### Phase 2: DatabaseController.js の修正

#### Step 2.1: クリア処理メソッドの追加

**ファイル**: `src/ui/controllers/DatabaseController.js`

**修正内容**: DatabaseControllerクラスに以下のメソッドを追加

```javascript
/**
 * 【追加】データベース表示時のクリアボタンイベント設定
 */
showDatabase() {
    try {
        // 既存の処理...
        const mainContent = document.getElementById('mainContent');
        if (!mainContent) {
            console.error('❌ Main content container not found');
            return;
        }
        
        mainContent.innerHTML = this.view.render();
        this.initialize();
        this.loadTransactionsTab();
        
        // 【追加】クリアボタンのイベント設定
        this.#setupClearButtonEvent();
        
        console.log('Database page displayed successfully in main-content');
    } catch (error) {
        console.error('Failed to show database page:', error);
        this.showMessage('データベースページの表示に失敗しました', 'error');
    }
}

/**
 * 【追加】クリアボタンイベント設定
 * @private
 */
#setupClearButtonEvent() {
    const clearBtn = document.getElementById('databaseClearBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            this.startClearProcess();
        });
    }
}

/**
 * 【追加】データクリアプロセス開始
 */
startClearProcess() {
    console.log('🗑️ データクリアプロセス開始');
    
    try {
        // 第1段階の確認モーダルを表示
        this.view.showClearConfirmModal(1);
    } catch (error) {
        console.error('Failed to start clear process:', error);
        this.showMessage('クリア処理の開始に失敗しました', 'error');
    }
}

/**
 * 【追加】クリアモーダルアクション処理
 * @param {string} action - アクション種別
 * @param {number} stage - 現在の段階
 */
handleClearAction(action, stage) {
    console.log(`🔄 クリアアクション: ${action} (段階: ${stage})`);
    
    switch (action) {
        case 'cancel':
            this.#handleCancelAction();
            break;
        case 'continue':
            this.#handleContinueAction(stage);
            break;
        case 'execute':
            this.#handleExecuteAction();
            break;
        case 'final-execute':
            this.#handleFinalExecuteAction();
            break;
        case 'close':
            this.#handleCloseAction();
            break;
        default:
            console.warn(`Unknown clear action: ${action}`);
    }
}

/**
 * 【追加】キャンセルアクション処理
 * @private
 */
#handleCancelAction() {
    console.log('❌ データクリア処理をキャンセル');
    this.view.hideClearConfirmModal();
}

/**
 * 【追加】続行アクション処理（第1段階→第2段階）
 * @param {number} stage - 現在の段階
 * @private
 */
#handleContinueAction(stage) {
    if (stage === 1) {
        console.log('📊 データプレビューを表示');
        
        // データ統計を取得
        const dataStats = this.#getDataStatistics();
        
        // 第2段階モーダルを表示
        this.view.showClearConfirmModal(2, dataStats);
    }
}

/**
 * 【追加】削除実行アクション処理（第2段階→第3段階）
 * @private
 */
#handleExecuteAction() {
    console.log('🔴 最終確認段階に移行');
    
    // 第3段階モーダルを表示
    this.view.showClearConfirmModal(3);
}

/**
 * 【追加】最終削除実行アクション処理
 * @private
 */
async #handleFinalExecuteAction() {
    console.log('🗑️ データ削除を実行中...');
    
    try {
        // 進捗表示開始
        this.view.showClearConfirmModal(4, { progress: 0, message: '削除準備中...' });
        
        // 段階的進捗表示
        await this.#executeWithProgress();
        
    } catch (error) {
        console.error('Data clear execution failed:', error);
        
        // エラー表示
        this.view.showClearConfirmModal(5, {
            success: false,
            message: 'データ削除エラー'
        });
    }
}

/**
 * 【追加】進捗付きでデータ削除実行
 * @private
 */
async #executeWithProgress() {
    // 進捗段階の定義
    const progressSteps = [
        { progress: 20, message: '投資信託データを削除中...', delay: 500 },
        { progress: 40, message: '個別株データを削除中...', delay: 500 },
        { progress: 60, message: '仮想通貨データを削除中...', delay: 300 },
        { progress: 80, message: '取引履歴を削除中...', delay: 500 },
        { progress: 100, message: '削除処理完了', delay: 300 }
    ];
    
    // 段階的進捗表示
    for (const step of progressSteps) {
        this.view.showClearConfirmModal(4, step);
        await this.#delay(step.delay);
    }
    
    // 実際の削除処理
    const clearSuccess = this.#executeClearData();
    
    // 結果表示
    this.view.showClearConfirmModal(5, {
        success: clearSuccess,
        message: clearSuccess ? 'データ削除完了' : 'データ削除エラー'
    });
}

/**
 * 【追加】実際のデータ削除処理
 * @returns {boolean} 削除成功の可否
 * @private
 */
#executeClearData() {
    try {
        // DataStoreManagerのclearAllData()を呼び出し
        const success = this.dataStoreManager.clearAllData();
        
        if (success) {
            console.log('✅ 全データ削除成功');
            return true;
        } else {
            console.error('❌ データ削除に失敗');
            return false;
        }
    } catch (error) {
        console.error('❌ データ削除中にエラー:', error);
        return false;
    }
}

/**
 * 【追加】完了時のクローズアクション処理
 * @private
 */
#handleCloseAction() {
    console.log('🔄 ページリフレッシュ');
    
    // モーダルを閉じる
    this.view.hideClearConfirmModal();
    
    // ページをリフレッシュして初期状態に戻る
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

/**
 * 【追加】データ統計情報取得
 * @returns {Object} データ統計
 * @private
 */
#getDataStatistics() {
    try {
        // DataStoreManagerからデータを取得
        const mutualFunds = this.dataStoreManager.getMutualFunds() || [];
        const stocks = this.dataStoreManager.getStocks() || [];
        const cryptoAssets = this.dataStoreManager.getCryptoAssets() || [];
        
        // LocalStorageサイズ計算
        let totalSize = 0;
        const keys = Object.values(this.dataStoreManager.STORAGE_KEYS);
        keys.forEach(key => {
            const data = localStorage.getItem(key);
            if (data) {
                totalSize += new Blob([data]).size;
            }
        });
        
        // 最終更新日取得（最新のデータから）
        const allData = [...mutualFunds, ...stocks, ...cryptoAssets];
        const lastUpdate = allData.length > 0 
            ? allData.reduce((latest, item) => {
                const itemDate = new Date(item.updatedAt || item.createdAt || 0);
                return itemDate > latest ? itemDate : latest;
              }, new Date(0)).toLocaleDateString('ja-JP')
            : '未設定';
        
        return {
            mutualFunds: mutualFunds.length,
            stocks: stocks.length,
            cryptoAssets: cryptoAssets.length,
            transactions: 0, // TODO: 取引履歴の実装時に修正
            dataSize: totalSize,
            lastUpdate: lastUpdate
        };
        
    } catch (error) {
        console.error('Failed to get data statistics:', error);
        return {
            mutualFunds: 0,
            stocks: 0,
            cryptoAssets: 0,
            transactions: 0,
            dataSize: 0,
            lastUpdate: '取得失敗'
        };
    }
}

/**
 * 【追加】遅延処理ヘルパー
 * @param {number} ms - 遅延時間（ミリ秒）
 * @returns {Promise} Promise
 * @private
 */
#delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
```

### Phase 3: DatabaseView.css の修正

#### Step 3.1: クリア機能用スタイルの追加

**ファイル**: `src/ui/styles/DatabaseView.css`

**追加内容**: ファイルの末尾に以下のCSSを追加

```css
/* ========================================
   データベースクリア機能用スタイル
   ======================================== */

/* クリアボタン */
.btn-database-clear {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
    margin-left: 0.75rem;
}

.btn-database-clear:hover {
    background: linear-gradient(135deg, #c82333, #a71e2a);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
}

.btn-database-clear:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
}

/* クリアモーダル基本スタイル */
.clear-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.clear-modal.modal-active {
    opacity: 1;
    visibility: visible;
}

.clear-dialog {
    background: white;
    border-radius: 12px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.clear-modal.modal-active .clear-dialog {
    transform: scale(1);
}

/* モーダルヘッダー */
.clear-modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.warning-header {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border-bottom-color: #f1c40f;
}

.data-header {
    background: linear-gradient(135deg, #d1ecf1, #a8dadc);
    border-bottom-color: #17a2b8;
}

.final-header {
    background: linear-gradient(135deg, #f8d7da, #f5b7b1);
    border-bottom-color: #dc3545;
}

.progress-header {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border-bottom-color: #28a745;
}

.success-header {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border-bottom-color: #28a745;
}

.modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #2c3e50;
}

.icon-warning,
.icon-data,
.icon-danger,
.icon-progress,
.icon-success {
    font-size: 1.5rem;
}

.modal-close-btn {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: #6c757d;
    padding: 0.25rem;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.modal-close-btn:hover {
    background: rgba(0, 0, 0, 0.1);
    color: #495057;
}

/* モーダルボディ */
.clear-modal-body {
    padding: 1.5rem;
    max-height: 50vh;
    overflow-y: auto;
}

/* 第1段階: 警告メッセージ */
.warning-message {
    text-align: center;
}

.warning-text {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.deletion-list {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    text-align: left;
}

.deletion-list h4 {
    margin: 0 0 0.75rem 0;
    color: #495057;
    font-size: 1rem;
}

.deletion-list ul {
    margin: 0;
    padding-left: 1.5rem;
    list-style: none;
}

.deletion-list li {
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
    color: #6c757d;
}

.critical-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 0.75rem;
}

.critical-warning p {
    margin: 0;
    color: #856404;
    font-weight: 500;
}

/* 第2段階: データプレビュー */
.data-preview {
    text-align: center;
}

.preview-intro {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 1rem;
}

.data-summary {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.data-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e9ecef;
}

.data-item:last-child {
    border-bottom: none;
}

.data-label {
    font-weight: 500;
    color: #495057;
}

.data-value {
    font-weight: 600;
    color: #2c3e50;
}

.warning-emphasis {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 0.75rem;
}

.warning-emphasis p {
    margin: 0;
    color: #856404;
    font-weight: 500;
}

/* 第3段階: 最終確認 */
.final-confirmation {
    text-align: center;
}

.final-warning {
    font-size: 1.1rem;
    color: #721c24;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.confirmation-input {
    margin-bottom: 1.5rem;
}

.confirmation-input label {
    display: block;
    margin-bottom: 0.75rem;
    color: #495057;
    font-weight: 500;
}

.confirmation-input-field {
    width: 100%;
    padding: 0.75rem;
    font-size: 1rem;
    border: 2px solid #ced4da;
    border-radius: 6px;
    text-align: center;
    font-weight: 600;
    transition: border-color 0.3s ease;
}

.confirmation-input-field:focus {
    outline: none;
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.final-warning-emphasis {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 6px;
    padding: 0.75rem;
}

.final-warning-emphasis p {
    margin: 0;
    color: #721c24;
    font-weight: 500;
}

/* 進捗表示 */
.progress-display {
    text-align: center;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #28a745, #20c997);
    transition: width 0.5s ease;
    border-radius: 10px;
}

.progress-message {
    font-size: 1.1rem;
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 1rem;
}

.progress-warning {
    font-size: 0.9rem;
    color: #6c757d;
    line-height: 1.5;
}

/* 完了表示 */
.completion-message {
    text-align: center;
    font-size: 1.1rem;
    color: #2c3e50;
    line-height: 1.6;
}

/* モーダルフッター */
.clear-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    background: #f8f9fa;
}

/* ボタンスタイル */
.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 80px;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-danger:disabled {
    background: #6c757d;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-danger.btn-enabled {
    background: #dc3545;
    cursor: pointer;
    opacity: 1;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .clear-dialog {
        width: 95%;
        max-width: none;
    }
    
    .clear-modal-header,
    .clear-modal-body,
    .clear-modal-footer {
        padding: 1rem;
    }
    
    .modal-title {
        font-size: 1.1rem;
    }
    
    .data-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
    
    .btn-database-clear {
        font-size: 0.8rem;
        padding: 0.375rem 0.75rem;
        margin-left: 0.5rem;
    }
}

/* アニメーション */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.clear-modal-body > * {
    animation: fadeIn 0.3s ease;
}

/* フォーカス管理 */
.confirmation-input-field:focus {
    outline: none;
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* ダークモード対応（将来用） */
@media (prefers-color-scheme: dark) {
    .clear-dialog {
        background: #2c3e50;
        color: #ecf0f1;
    }
    
    .clear-modal-header {
        border-bottom-color: #34495e;
    }
    
    .clear-modal-footer {
        background: #34495e;
        border-top-color: #34495e;
    }
    
    .data-summary,
    .deletion-list {
        background: #34495e;
        border-color: #4a5568;
    }
}
```

## 3. 実装スケジュール

### 今日の実装推奨順序（2-3時間）

#### 【優先度：高】必須実装項目

1. **DatabaseView.js修正**（1時間30分）
   - クリアボタンの追加
   - モーダル表示メソッドの実装
   - 段階別コンテンツ生成メソッド

2. **DatabaseController.js修正**（1時間）
   - クリア処理制御ロジックの追加
   - DataStoreManagerとの連携
   - 進捗表示・完了処理

3. **CSS追加**（30分）
   - クリア機能用スタイルシートの追加
   - レスポンシブ対応

#### 【優先度：中】追加実装項目（明日以降）

1. **エラーハンドリング強化**（1時間）
   - LocalStorageエラー対応
   - 部分削除失敗時の処理

2. **ユーザビリティ改善**（1時間）
   - アニメーション追加
   - アクセシビリティ対応

## 4. テスト計画

### 4.1 動作確認項目

#### 基本機能テスト
- [ ] クリアボタンの表示・クリック動作
- [ ] 3段階確認モーダルの表示
- [ ] 確認テキスト入力の検証（"DELETE"）
- [ ] データ削除処理の実行
- [ ] 進捗表示の動作
- [ ] 完了後のページリフレッシュ

#### データ削除テスト
- [ ] 投資信託データの削除確認
- [ ] 個別株データの削除確認
- [ ] 仮想通貨データの削除確認
- [ ] LocalStorageの完全クリア確認

#### 安全性テスト
- [ ] キャンセル操作の動作（各段階）
- [ ] ESCキーでの閉じる動作
- [ ] 確認テキスト未入力時のボタン無効化
- [ ] オーバーレイクリックでの閉じる動作（最終段階以外）

### 4.2 エラーケーステスト

#### LocalStorageエラー
- [ ] プライベートモード時の動作
- [ ] 容量不足時の動作
- [ ] アクセス拒否時の動作

#### 実装時のテストコマンド

```javascript
// ブラウザコンソールでのテスト用コマンド

// 1. データクリア機能の動作確認
window.databaseController.startClearProcess();

// 2. データ統計の確認
console.log(window.databaseController.getDataStatistics());

// 3. DataStoreManagerの直接呼び出し確認
window.databaseController.dataStoreManager.clearAllData();

// 4. LocalStorageの状態確認
console.log('LocalStorage keys:', Object.keys(localStorage));
```

## 5. 成功指標とリスク管理

### 5.1 成功指標
- ✅ 誤操作防止率: 100%（3段階確認の完全実装）
- ✅ データ削除成功率: 100%
- ✅ ユーザーインターフェースの直感性: 4.0/5.0以上

### 5.2 リスク対策
- **誤操作リスク**: 多重確認・明確な警告表示で対策
- **データ復旧不可リスク**: 事前警告・プレビュー表示で対策
- **処理中断リスク**: プログレス表示・キャンセル制限で対策

---

**実装開始**: この計画書の手順に従って、DatabaseView.js → DatabaseController.js → CSS の順で実装することを推奨します。各段階で動作確認を行いながら進めてください。

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"id": "1", "content": "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30af\u30ea\u30a2\u6a5f\u80fd\u306e\u73fe\u5728\u306e\u5b9f\u88c5\u72b6\u6cc1\u3092\u8abf\u67fb", "status": "completed"}, {"id": "2", "content": "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30af\u30ea\u30a2\u6a5f\u80fd\u306e\u8981\u4ef6\u5b9a\u7fa9\u66f8\u3092\u4f5c\u6210", "status": "completed"}, {"id": "3", "content": "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30af\u30ea\u30a2\u6a5f\u80fd\u306e\u5b9f\u88c5\u8a08\u753b\u66f8\u3092\u4f5c\u6210\uff08\u5177\u4f53\u7684\u30d5\u30a1\u30a4\u30eb\u4fee\u6b63\u6307\u793a\u542b\u3080\uff09", "status": "completed"}]