# 投資信託追加フォーム - 要件定義書

**作成日**: 2025年9月11日  
**対象機能**: 投資信託追加フォーム  
**アーキテクチャ**: レイヤードアーキテクチャ

## 📋 機能概要

### 基本機能
新しい投資信託をポートフォリオに追加するためのモーダルフォーム機能

### 主要な価値提案
- **直感的な入力体験**: ユーザーフレンドリーなフォームUI
- **データ品質保証**: リアルタイムバリデーションによるエラー防止
- **効率的な運用**: 既存ダッシュボードとのシームレス統合

## 🏗 レイヤードアーキテクチャ設計

### 1. UI Layer (Presentation Layer)
**責任**: ユーザーインターフェースの提供と制御

#### 1.1 AssetFormView.js
**場所**: `src/ui/views/AssetFormView.js`  
**責任**: フォームの描画とDOM操作のみ

```javascript
// 実装予定の構造
class AssetFormView {
    // モーダル表示/非表示
    showModal()
    hideModal()
    
    // フォーム描画
    renderForm()
    resetForm()
    
    // バリデーションメッセージ表示
    showFieldError(fieldName, message)
    clearFieldErrors()
    
    // ローディング状態
    showLoading()
    hideLoading()
    
    // 成功フィードバック
    showSuccessMessage()
}
```

**具体的な機能**:
- モーダルダイアログの表示・非表示
- 入力フィールドの描画（name, type, totalInvestment, etc.）
- エラーメッセージの表示・消去
- ローディングスピナーの制御
- 成功時のアニメーション・メッセージ

#### 1.2 AssetFormController.js
**場所**: `src/ui/controllers/AssetFormController.js`  
**責任**: フォームの制御ロジックとデータの仲介

```javascript
// 実装予定の構造
class AssetFormController {
    // 初期化
    constructor(assetRepository, dashboardController)
    
    // フォーム開閉制御
    openForm()
    closeForm()
    
    // イベントハンドリング
    handleSubmit(formData)
    handleFieldChange(fieldName, value)
    handleCancel()
    
    // バリデーション制御
    validateField(fieldName, value)
    validateForm(formData)
    
    // データ処理
    saveAsset(validatedData)
}
```

**具体的な機能**:
- フォーム開閉の制御
- ユーザー入力イベントの処理
- リアルタイムバリデーションの実行
- ビジネス層・データ層との連携
- エラーハンドリングと表示制御

### 2. Business Layer
**責任**: ビジネスルールとドメインロジック

#### 2.1 AssetEntity.js (既存Asset.js分割)
**場所**: `src/business/models/AssetEntity.js`  
**責任**: 資産データエンティティとCRUD操作

**主要機能**:
```javascript
// Asset.jsから分割された定義系クラス
class AssetEntity {
    // データ構造定義
    constructor(data)
    validate()
    
    // CRUD操作
    updateCurrentValue(newValue)
    addInvestment(amount, quantity)
    
    // フォーム専用ファクトリーメソッド
    static createFromForm(formData)
    
    // シリアライゼーション
    toJSON()
    static fromJSON(json)
    
    // ビジネス定数・ヘルパー
    static get VALID_TYPES()
    static checkDuplicate(name, existingAssets)
}
```

#### 2.2 AssetCalculator.js (新規作成)
**場所**: `src/business/models/AssetCalculator.js`  
**責任**: 投資資産の計算・分析ロジック

**主要機能**:
```javascript
// Asset.jsから分割された計算系クラス
class AssetCalculator {
    // 基本計算
    static getUnrealizedGainLoss(assetEntity)
    static getReturnPercentage(assetEntity)
    
    // ポートフォリオ計算
    static getTotalValue(assetEntities)
    static getPortfolioAllocation(assetEntities)
    
    // 比較・ランキング
    static comparePerformance(asset1, asset2)
    static rankAssetsByPerformance(assetEntities)
}
```

#### 2.3 AssetFormValidator.js (新規作成)
**場所**: `src/business/validators/AssetFormValidator.js`  
**責任**: フォーム専用のバリデーションルール

```javascript
// 新規作成予定
class AssetFormValidator {
    // 個別フィールドバリデーション
    static validateName(value)
    static validateType(value)
    static validateTotalInvestment(value)
    static validateCurrentValue(value)
    static validateQuantity(value)
    
    // 複合バリデーション
    static validateFormData(formData)
    static validateBusinessRules(formData)
    
    // エラーメッセージ生成
    static getErrorMessages(validationResults)
}
```

### 3. Data Layer
**責任**: データアクセスと永続化

#### 3.1 AssetRepository.js (既存活用)
**場所**: `src/data/repositories/AssetRepository.js`  
**責任**: データの永続化と取得

**活用予定の既存機能**:
```javascript
// 既存機能を活用（AssetEntityインスタンスを扱う）
assetRepository.addAsset(assetEntityData)
assetRepository.getAllAssets() // AssetEntity配列を返す
assetRepository.getAssetByName(name) // 重複チェック用
```

### 4. Infrastructure Layer
**責任**: 外部システムとの連携

#### 4.1 LocalStorageAdapter.js (既存活用)
**場所**: `src/infrastructure/LocalStorageAdapter.js`  
**責任**: ブラウザストレージとの連携

**既存機能の活用**: データの保存・読み込み機能をそのまま使用

## 📝 詳細機能仕様

### 1. フォームフィールド仕様

#### 必須フィールド
| フィールド名 | 型 | バリデーション | 説明 |
|-------------|-----|---------------|------|
| **name** | string | 必須, 1-100文字, 重複不可 | 投資信託名 |
| **type** | select | 必須, 列挙値 | 資産タイプ |
| **totalInvestment** | number | 必須, >0, 整数 | 総投資額 |

#### オプションフィールド
| フィールド名 | 型 | バリデーション | 説明 |
|-------------|-----|---------------|------|
| **currentValue** | number | >=0, 整数 | 現在価値 |
| **quantity** | number | >=0 | 保有数量 |
| **region** | select | 列挙値 | 地域 |
| **currency** | select | 列挙値 | 通貨 |
| **sector** | string | 0-50文字 | セクター |
| **description** | textarea | 0-500文字 | 説明 |

### 2. バリデーション仕様

#### リアルタイムバリデーション
- **入力時**: keyup, change イベントで即座にチェック
- **表示**: エラーメッセージをフィールド下に赤色で表示
- **成功**: ✓マークでバリデーション成功を視覚的に表示

#### サーバサイドバリデーション風
```javascript
// バリデーションルール例
const validationRules = {
    name: {
        required: true,
        minLength: 1,
        maxLength: 100,
        uniqueCheck: true
    },
    totalInvestment: {
        required: true,
        type: 'number',
        min: 1,
        integer: true
    },
    type: {
        required: true,
        enum: ['mutualFund', 'stock', 'bond', 'reit', 'crypto', 'other']
    }
}
```

### 3. ユーザーエクスペリエンス仕様

#### モーダル動作
- **開く**: ダッシュボードの「追加」ボタンクリック
- **背景**: 半透明オーバーレイでフォーカス
- **閉じる**: ESCキー、×ボタン、背景クリック、キャンセルボタン
- **アニメーション**: フェードイン・フェードアウト（300ms）

#### フォーム送信フロー
```
1. ユーザー入力 
   ↓
2. リアルタイムバリデーション
   ↓
3. 送信ボタンクリック
   ↓
4. フォーム全体バリデーション
   ↓
5. ローディング表示
   ↓
6. データ保存（LocalStorage）
   ↓
7. 成功メッセージ表示
   ↓
8. ダッシュボード更新
   ↓
9. モーダル自動クローズ
```

### 4. エラーハンドリング仕様

#### エラー種別と対応
| エラー種別 | 発生タイミング | 表示方法 | 復旧方法 |
|-----------|---------------|----------|----------|
| **必須項目未入力** | リアルタイム | フィールド下赤字 | 入力修正 |
| **形式エラー** | リアルタイム | フィールド下赤字 | 入力修正 |
| **重複エラー** | 送信時 | フォーム上部警告 | 名前変更 |
| **保存エラー** | 送信時 | モーダル上部エラー | 再試行 |
| **ネットワークエラー** | 送信時 | モーダル上部エラー | 再試行 |

## 🔄 データフロー設計

### 1. フォーム表示フロー
```
DashboardController.handleAddAsset()
    ↓
AssetFormController.openForm()
    ↓
AssetFormView.showModal()
    ↓
AssetFormView.renderForm()
```

### 2. バリデーションフロー
```
AssetFormView (ユーザー入力)
    ↓
AssetFormController.handleFieldChange()
    ↓
AssetFormValidator.validateField()
    ↓ (エラーの場合)
AssetFormView.showFieldError()
```

### 3. 保存フロー
```
AssetFormController.handleSubmit()
    ↓
AssetFormValidator.validateFormData()
    ↓
AssetEntity.createFromForm() // 分割後のエンティティクラス
    ↓
AssetRepository.addAsset()
    ↓
LocalStorageAdapter.save()
    ↓
DashboardController.refreshData()
    ↓
AssetFormView.showSuccessMessage()
```

## 📁 ファイル構成計画

### 新規作成ファイル
```
src/
├── ui/
│   ├── views/
│   │   └── AssetFormView.js        # 新規作成
│   └── controllers/
│       └── AssetFormController.js  # 新規作成
├── business/
│   └── validators/
│       └── AssetFormValidator.js   # 新規作成
public/
└── css/
    └── modal-form.css              # 新規作成
```

### 変更予定ファイル
```
src/
├── ui/
│   └── controllers/
│       └── DashboardController.js  # フォーム連携追加
├── business/
│   └── models/
│       ├── AssetEntity.js          # Asset.jsから分割（定義系）
│       ├── AssetCalculator.js      # Asset.jsから分割（計算系）
│       └── Asset.js                # 削除予定（分割完了後）
public/
└── css/
    └── components.css              # モーダルスタイル追加
```

## 🎯 成功指標

### 1. 機能面
- [ ] フォーム入力から保存まで30秒以内
- [ ] バリデーションエラー0.5秒以内に表示
- [ ] モーダル開閉アニメーション300ms
- [ ] 重複チェック機能100%動作

### 2. ユーザビリティ
- [ ] 必須項目の視覚的明示
- [ ] エラーメッセージの日本語対応
- [ ] キーボード操作対応（Tab, Enter, ESC）
- [ ] モバイルデバイス対応

### 3. 技術面
- [ ] レイヤー間の責任分離徹底
- [ ] 既存コードとの統合エラー0件
- [ ] メモリリーク0件
- [ ] コンソールエラー0件

## 📋 実装手順

### Phase 1: 基盤実装（Week 1）
1. AssetFormView.js 基本構造作成
2. AssetFormController.js 基本構造作成
3. モーダルCSS実装
4. DashboardController統合

### Phase 2: モデル分割・バリデーション実装（Week 2）
1. AssetEntity.js 作成（Asset.jsから分割）
2. AssetCalculator.js 作成（Asset.jsから分割）
3. AssetFormValidator.js の更新（新モデル対応）
4. リアルタイムバリデーション実装
5. エラーメッセージ表示機能
6. 重複チェック機能

### Phase 3: 統合・テスト（Week 3）
1. データ保存機能統合
2. ダッシュボード更新連携
3. エラーハンドリング強化
4. ユーザビリティ改善

### Phase 4: 仕上げ（Week 4）
1. アニメーション追加
2. モバイル対応
3. キーボード操作対応
4. 最終テスト・調整

## 🚀 拡張予定機能

### 将来機能（Phase 5以降）
- **自動補完**: 過去入力履歴からの候補表示
- **一括追加**: 複数銘柄の同時追加
- **テンプレート**: よく使う設定の保存
- **インポート**: CSV/Excelからの一括追加

このように、レイヤードアーキテクチャの各層に適切に機能を配置することで、保守性が高く拡張しやすい投資信託追加フォーム機能を実現します。