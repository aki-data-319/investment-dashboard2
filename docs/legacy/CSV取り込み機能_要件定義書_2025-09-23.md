# CSV取り込み機能 要件定義書

**作成日**: 2025-09-23  
**対象バージョン**: Investment Dashboard v2  
**作成者**: Claude Code  

## 概要

楽天証券の取引履歴CSVファイルを投資ダッシュボードに取り込み、ポートフォリオデータとして管理する機能の要件を定義します。

## 1. 機能概要

### 1.1 主要機能
- 楽天証券CSV（日本株・米国株・投資信託）の読み込み
- データのプレビュー表示
- 重複データの検出・スキップ
- データの正規化と保存
- ドライラン機能（確認のみ）

### 1.2 対象ユーザー
- 楽天証券で取引している個人投資家
- 投資データを一元管理したいユーザー

## 2. 現在の実装状況

### 2.1 実装済み機能

#### ✅ アーキテクチャ（レイヤード）
```
UI層: CsvImportView.js - ファイル選択、プレビュー表示UI
制御層: CsvImportController.js - イベント処理、View-Service連携
アプリケーション層: CsvImportService.js - CSV処理ユースケース
インフラ層: RakutenCsvParser.js - CSV解析エンジン
ドメイン層: TransactionEntity.js - 取引データモデル
```

#### ✅ CSV形式対応
- **日本株式** (JP): 28列の楽天証券日本株取引履歴
- **米国株式** (US): 18列の楽天証券米国株取引履歴  
- **投資信託** (INVST): 14列の楽天証券投資信託取引履歴

#### ✅ 文字エンコーディング対応
- Shift-JIS、UTF-8、ISO-8859-1の自動検出
- 日本語文字化け完全対策

#### ✅ データ処理機能
- CSV→TransactionEntity正規化
- プレビュー機能（最大1000件表示）
- 重複スキップオプション
- ドライラン機能

#### ✅ UI機能
- ドラッグ&ドロップ対応
- プレビューテーブル表示
- インポート結果表示
- オプション設定（重複スキップ・ドライラン）

### 2.2 技術仕様

#### パーサー機能 (RakutenCsvParser v2.0.0)
- **入力**: 楽天証券CSVファイル
- **出力**: TransactionEntity配列
- **エラーハンドリング**: 行単位のエラー回復
- **パフォーマンス**: 大容量ファイル対応

#### データモデル (TransactionEntity)
```javascript
{
  source: 'rakuten',           // データソース
  subtype: 'jp_equity|us_equity|mutual_fund',
  tradeDate: 'YYYY-MM-DD',     // 約定日
  settleDate: 'YYYY-MM-DD',    // 受渡日
  symbol: 'string',            // 銘柄コード/ティッカー
  name: 'string',              // 銘柄名
  tradeType: 'buy|sell|other', // 売買区分
  quantity: number,            // 数量
  price: number,               // 単価
  settledAmount: number,       // 受渡金額（符号付き）
  settledCurrency: 'JPY|USD',  // 決済通貨
  fxRate: number,              // 為替レート（米国株）
  // その他手数料、税金等...
}
```

## 3. 要件定義

### 3.1 機能要件

#### F1. ファイル取り込み機能
- **F1.1**: 楽天証券の3種類CSV形式（JP/US/INVST）を受け付ける
- **F1.2**: ドラッグ&ドロップまたはファイル選択でCSVを読み込む
- **F1.3**: Shift-JIS/UTF-8エンコーディングを自動判定して正常読み込み
- **F1.4**: ファイル形式不正時は明確なエラーメッセージを表示

#### F2. データプレビュー機能  
- **F2.1**: CSV解析後、最大10行のプレビューを表示
- **F2.2**: 検出されたCSV形式、総件数を表示
- **F2.3**: データ異常（エンコーディングエラー等）を警告表示
- **F2.4**: プレビューテーブルで日付、銘柄、売買、数量、金額を確認可能

#### F3. データインポート機能
- **F3.1**: 重複データ検出・スキップ機能（同名資産基準）
- **F3.2**: ドライラン機能（実際には保存せず件数のみ表示）
- **F3.3**: インポート完了後、件数サマリーを表示
- **F3.4**: エラー時は詳細なエラー情報を表示

#### F4. データ保存機能
- **F4.1**: TransactionEntityとしてトランザクション台帳に保存
- **F4.2**: デデュープ機能（fingerprint基準）
- **F4.3**: バッチメタデータ（source, subtype, parserVersion）記録
- **F4.4**: 保存後は自動的にダッシュボード画面に遷移

### 3.2 非機能要件

#### N1. パフォーマンス
- **N1.1**: 10,000行のCSVファイルを30秒以内で処理
- **N1.2**: プレビュー表示は2秒以内
- **N1.3**: メモリ使用量は100MB以下（大容量CSV処理時）

#### N2. ユーザビリティ
- **N2.1**: 処理進捗を視覚的に表示
- **N2.2**: エラーメッセージは日本語で分かりやすく表示
- **N2.3**: 操作手順が直感的で迷わない

#### N3. 信頼性
- **N3.1**: CSV形式不正時でもアプリケーションがクラッシュしない
- **N3.2**: 部分的な行エラーでも処理可能な行は正常処理
- **N3.3**: データ保存前の検証機能

## 4. 想定される使用シナリオ

### 4.1 基本シナリオ
1. ユーザーがCSV取り込み画面を開く
2. 楽天証券からダウンロードしたCSVファイルを選択
3. プレビューボタンでデータ確認
4. オプション設定（重複スキップ・ドライラン）
5. インポートボタンで実行
6. 結果確認後、ダッシュボードに遷移

### 4.2 エラーシナリオ
- **無効なファイル**: 明確なエラーメッセージ表示
- **文字化け**: 自動エンコーディング修正
- **重複データ**: スキップ件数表示
- **ネットワークエラー**: リトライ機能

## 5. 制約事項

### 5.1 対応CSV形式
- 楽天証券の取引履歴CSVのみ対応
- SBI証券等、他社CSVは対象外

### 5.2 データサイズ制限
- 単一ファイルサイズ: 最大50MB
- 処理行数: 最大100,000行

### 5.3 ブラウザ対応
- Chrome 90+、Firefox 88+、Safari 14+
- Internet Explorer は対象外

## 6. 今後の拡張計画

### 6.1 短期計画（Phase 2）
- SBI証券CSV対応
- 複数ファイル一括処理
- インポート履歴管理

### 6.2 中期計画（Phase 3）
- 手動CSV列マッピング機能
- カスタムCSV形式対応
- APIからの自動取得

---

**注記**: この要件定義書は現在の実装状況を基に作成されており、実際の動作確認と合わせて随時更新します。